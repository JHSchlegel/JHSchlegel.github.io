<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jan Schlegel">
<meta name="dcterms.date" content="2025-07-26">

<title>Jan Schlegel – Advanced Portfolio Optimization: From Markowitz to Expected Shortfall and Genetic Algorithms</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<meta name="color-scheme" content="dark light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jan Schlegel</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/jan-heinrich-schlegel/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/JHSchlegel"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Advanced Portfolio Optimization: From Markowitz to Expected Shortfall and Genetic Algorithms</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Finance</div>
                <div class="quarto-category">Python</div>
                <div class="quarto-category">Optimization</div>
                <div class="quarto-category">Risk Management</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Jan Schlegel </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 26, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  <div>
    <div class="abstract">
      <div class="block-title">Abstract</div>
      This comprehensive exploration of portfolio optimization covers the mathematical foundations from classical mean-variance optimization to modern approaches including Expected Shortfall (CVaR) optimization and genetic algorithms. We provide rigorous mathematical derivations, implement multiple optimization techniques in Python, and compare their performance on real market data with publication-ready visualizations throughout.
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sec-introduction" id="toc-sec-introduction" class="nav-link active" data-scroll-target="#sec-introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#sec-foundations" id="toc-sec-foundations" class="nav-link" data-scroll-target="#sec-foundations"><span class="header-section-number">2</span> Mathematical Foundations</a>
  <ul class="collapse">
  <li><a href="#sec-markowitz" id="toc-sec-markowitz" class="nav-link" data-scroll-target="#sec-markowitz"><span class="header-section-number">2.1</span> Classical Mean-Variance Framework</a></li>
  <li><a href="#sec-expected-shortfall" id="toc-sec-expected-shortfall" class="nav-link" data-scroll-target="#sec-expected-shortfall"><span class="header-section-number">2.2</span> Expected Shortfall Framework</a></li>
  <li><a href="#sec-genetic-algorithms" id="toc-sec-genetic-algorithms" class="nav-link" data-scroll-target="#sec-genetic-algorithms"><span class="header-section-number">2.3</span> Genetic Algorithm Framework</a></li>
  </ul></li>
  <li><a href="#sec-data" id="toc-sec-data" class="nav-link" data-scroll-target="#sec-data"><span class="header-section-number">3</span> Data Acquisition and Preprocessing</a></li>
  <li><a href="#sec-shrinkage" id="toc-sec-shrinkage" class="nav-link" data-scroll-target="#sec-shrinkage"><span class="header-section-number">4</span> Covariance Matrix Estimation and Shrinkage</a>
  <ul class="collapse">
  <li><a href="#the-curse-of-dimensionality-in-covariance-estimation" id="toc-the-curse-of-dimensionality-in-covariance-estimation" class="nav-link" data-scroll-target="#the-curse-of-dimensionality-in-covariance-estimation"><span class="header-section-number">4.1</span> The Curse of Dimensionality in Covariance Estimation</a></li>
  <li><a href="#shrinkage-estimation" id="toc-shrinkage-estimation" class="nav-link" data-scroll-target="#shrinkage-estimation"><span class="header-section-number">4.2</span> Shrinkage Estimation</a></li>
  </ul></li>
  <li><a href="#sec-mv-implementation" id="toc-sec-mv-implementation" class="nav-link" data-scroll-target="#sec-mv-implementation"><span class="header-section-number">5</span> Mean-Variance Optimization Implementation</a></li>
  <li><a href="#sec-cvar-implementation" id="toc-sec-cvar-implementation" class="nav-link" data-scroll-target="#sec-cvar-implementation"><span class="header-section-number">6</span> Expected Shortfall (CVaR) Optimization</a></li>
  <li><a href="#sec-ga-implementation" id="toc-sec-ga-implementation" class="nav-link" data-scroll-target="#sec-ga-implementation"><span class="header-section-number">7</span> Genetic Algorithm Optimization</a></li>
  <li><a href="#sec-conclusions" id="toc-sec-conclusions" class="nav-link" data-scroll-target="#sec-conclusions"><span class="header-section-number">8</span> Conclusions and Practical Implications</a>
  <ul class="collapse">
  <li><a href="#key-findings" id="toc-key-findings" class="nav-link" data-scroll-target="#key-findings"><span class="header-section-number">8.1</span> Key Findings</a></li>
  <li><a href="#performance-comparison" id="toc-performance-comparison" class="nav-link" data-scroll-target="#performance-comparison"><span class="header-section-number">8.2</span> Performance Comparison</a></li>
  <li><a href="#practical-recommendations" id="toc-practical-recommendations" class="nav-link" data-scroll-target="#practical-recommendations"><span class="header-section-number">8.3</span> Practical Recommendations</a></li>
  <li><a href="#limitations-and-future-research" id="toc-limitations-and-future-research" class="nav-link" data-scroll-target="#limitations-and-future-research"><span class="header-section-number">8.4</span> Limitations and Future Research</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">9</span> References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/portfolio_optimization_thumbnail.png" class="img-fluid figure-img"></p>
<figcaption>Portfolio optimization combines mathematical rigor with practical financial applications</figcaption>
</figure>
</div>
<section id="sec-introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="sec-introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>Portfolio optimization lies at the heart of modern financial theory, seeking to balance the eternal trade-off between risk and return. Since Harry Markowitz’s seminal 1952 paper <span class="citation" data-cites="markowitz1952">(<a href="#ref-markowitz1952" role="doc-biblioref">Markowitz 1952</a>)</span>, which introduced the mean-variance framework and earned him the Nobel Prize in Economics, portfolio optimization has evolved dramatically to address the limitations and real-world complexities of financial markets.</p>
<p>The classical Markowitz approach, while mathematically elegant, relies on several restrictive assumptions: normality of returns, quadratic utility functions, and the adequacy of variance as a risk measure. However, extensive empirical evidence demonstrates that financial returns exhibit fat tails, skewness, and time-varying volatility <span class="citation" data-cites="mandelbrot1963 fama1965">(<a href="#ref-mandelbrot1963" role="doc-biblioref">Mandelbrot 1963</a>; <a href="#ref-fama1965" role="doc-biblioref">Fama 1965</a>)</span>. These stylized facts have motivated the development of alternative risk measures and optimization techniques.</p>
<p>Expected Shortfall (ES), also known as Conditional Value at Risk (CVaR), has emerged as a coherent risk measure that addresses many limitations of Value at Risk (VaR) <span class="citation" data-cites="artzner1999 rockafellar2000">(<a href="#ref-artzner1999" role="doc-biblioref">Artzner et al. 1999</a>; <a href="#ref-rockafellar2000" role="doc-biblioref">Rockafellar and Uryasev 2000</a>)</span>. Unlike VaR, ES satisfies all axioms of coherent risk measures and provides information about the magnitude of losses beyond the VaR threshold. This makes ES-based portfolio optimization particularly attractive for risk management applications.</p>
<p>Moreover, the computational complexity of portfolio optimization problems, especially when incorporating realistic constraints and non-convex objectives, has led to the adoption of metaheuristic algorithms. Genetic algorithms (GAs), inspired by natural selection and evolution, offer a powerful framework for solving complex optimization problems that may be intractable for traditional methods <span class="citation" data-cites="holland1975 goldberg1989">(<a href="#ref-holland1975" role="doc-biblioref">Holland 1975</a>; <a href="#ref-goldberg1989" role="doc-biblioref">Goldberg 1989</a>)</span>.</p>
<p>This study provides a comprehensive analysis of three distinct portfolio optimization approaches:</p>
<ol type="1">
<li><strong>Classical Mean-Variance Optimization</strong>: The foundational Markowitz framework with its mathematical elegance and analytical solutions</li>
<li><strong>Expected Shortfall Optimization</strong>: A coherent alternative that captures tail risk more effectively<br>
</li>
<li><strong>Genetic Algorithm Optimization</strong>: A metaheuristic approach capable of handling complex, non-convex optimization landscapes</li>
</ol>
<p>We implement these methods on a diversified portfolio of technology stocks, providing detailed mathematical derivations, Python implementations, and comparative performance analysis. Our contribution extends beyond simple implementation by providing rigorous mathematical foundations, publication-ready visualizations, and practical insights for portfolio managers and quantitative analysts.</p>
</section>
<section id="sec-foundations" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="sec-foundations"><span class="header-section-number">2</span> Mathematical Foundations</h2>
<section id="sec-markowitz" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="sec-markowitz"><span class="header-section-number">2.1</span> Classical Mean-Variance Framework</h3>
<p>The Markowitz mean-variance framework forms the cornerstone of modern portfolio theory. Consider a universe of <span class="math inline">\(n\)</span> risky assets with expected returns <span class="math inline">\(\boldsymbol{\mu} = (\mu_1, \mu_2, \ldots, \mu_n)^T\)</span> and covariance matrix <span class="math inline">\(\boldsymbol{\Sigma} \in \mathbb{R}^{n \times n}\)</span>. A portfolio is defined by weight vector <span class="math inline">\(\mathbf{w} = (w_1, w_2, \ldots, w_n)^T\)</span> where <span class="math inline">\(w_i\)</span> represents the proportion of wealth invested in asset <span class="math inline">\(i\)</span>.</p>
<p>The portfolio return is given by: <span id="eq-portfolio-return"><span class="math display">\[
r_p = \mathbf{w}^T \mathbf{r}
\tag{1}\]</span></span></p>
<p>where <span class="math inline">\(\mathbf{r} = (r_1, r_2, \ldots, r_n)^T\)</span> is the vector of asset returns.</p>
<p>The expected portfolio return and variance are: <span id="eq-portfolio-moments"><span class="math display">\[
\begin{align}
\mathbb{E}[r_p] &amp;= \mathbf{w}^T \boldsymbol{\mu} \\
\text{Var}[r_p] &amp;= \mathbf{w}^T \boldsymbol{\Sigma} \mathbf{w}
\end{align}
\tag{2}\]</span></span></p>
<section id="the-mean-variance-optimization-problem" class="level4" data-number="2.1.1">
<h4 data-number="2.1.1" class="anchored" data-anchor-id="the-mean-variance-optimization-problem"><span class="header-section-number">2.1.1</span> The Mean-Variance Optimization Problem</h4>
<p>The classical mean-variance optimization problem can be formulated in several equivalent ways. The most common formulation minimizes portfolio variance for a given target return:</p>
<p><span id="eq-mv-problem"><span class="math display">\[
\begin{align}
\min_{\mathbf{w}} &amp;\quad \frac{1}{2}\mathbf{w}^T \boldsymbol{\Sigma} \mathbf{w} \\
\text{s.t.} &amp;\quad \mathbf{w}^T \boldsymbol{\mu} = \mu_p \\
&amp;\quad \mathbf{w}^T \mathbf{1} = 1
\end{align}
\tag{3}\]</span></span></p>
<p>where <span class="math inline">\(\mu_p\)</span> is the target expected return and <span class="math inline">\(\mathbf{1}\)</span> is a vector of ones.</p>
<p>Using Lagrangian optimization, the analytical solution is: <span id="eq-mv-solution"><span class="math display">\[
\mathbf{w}^* = \frac{A\boldsymbol{\Sigma}^{-1}\boldsymbol{\mu} - B\boldsymbol{\Sigma}^{-1}\mathbf{1}}{AC - B^2}\mu_p + \frac{C\boldsymbol{\Sigma}^{-1}\mathbf{1} - B\boldsymbol{\Sigma}^{-1}\boldsymbol{\mu}}{AC - B^2}
\tag{4}\]</span></span></p>
<p>where: <span id="eq-mv-constants"><span class="math display">\[
\begin{align}
A &amp;= \mathbf{1}^T \boldsymbol{\Sigma}^{-1} \mathbf{1} \\
B &amp;= \mathbf{1}^T \boldsymbol{\Sigma}^{-1} \boldsymbol{\mu} \\
C &amp;= \boldsymbol{\mu}^T \boldsymbol{\Sigma}^{-1} \boldsymbol{\mu}
\end{align}
\tag{5}\]</span></span></p>
</section>
<section id="the-efficient-frontier" class="level4" data-number="2.1.2">
<h4 data-number="2.1.2" class="anchored" data-anchor-id="the-efficient-frontier"><span class="header-section-number">2.1.2</span> The Efficient Frontier</h4>
<p>The efficient frontier represents the set of portfolios that offer the highest expected return for each level of risk. The minimum variance of any portfolio with expected return <span class="math inline">\(\mu_p\)</span> is:</p>
<p><span id="eq-efficient-frontier"><span class="math display">\[
\sigma_p^2(\mu_p) = \frac{A\mu_p^2 - 2B\mu_p + C}{AC - B^2}
\tag{6}\]</span></span></p>
</section>
</section>
<section id="sec-expected-shortfall" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="sec-expected-shortfall"><span class="header-section-number">2.2</span> Expected Shortfall Framework</h3>
<p>Expected Shortfall (ES), also known as Conditional Value at Risk (CVaR), addresses several limitations of Value at Risk and variance as risk measures. For a given confidence level <span class="math inline">\(\alpha \in (0,1)\)</span>, ES is defined as the expected loss beyond the VaR threshold.</p>
<section id="mathematical-definition" class="level4" data-number="2.2.1">
<h4 data-number="2.2.1" class="anchored" data-anchor-id="mathematical-definition"><span class="header-section-number">2.2.1</span> Mathematical Definition</h4>
<p>For a portfolio return <span class="math inline">\(r_p\)</span> with cumulative distribution function <span class="math inline">\(F_{r_p}(x)\)</span>, the Value at Risk at confidence level <span class="math inline">\(\alpha\)</span> is: <span id="eq-var-definition"><span class="math display">\[
\text{VaR}_\alpha = -\inf\{x : F_{r_p}(x) \geq \alpha\} = -F_{r_p}^{-1}(\alpha)
\tag{7}\]</span></span></p>
<p>The Expected Shortfall is then defined as: <span id="eq-es-definition"><span class="math display">\[
\text{ES}_\alpha = -\mathbb{E}[r_p | r_p \leq -\text{VaR}_\alpha] = -\frac{1}{\alpha}\int_0^\alpha F_{r_p}^{-1}(u) du
\tag{8}\]</span></span></p>
</section>
<section id="coherent-risk-measure-properties" class="level4" data-number="2.2.2">
<h4 data-number="2.2.2" class="anchored" data-anchor-id="coherent-risk-measure-properties"><span class="header-section-number">2.2.2</span> Coherent Risk Measure Properties</h4>
<p>Expected Shortfall satisfies all four axioms of coherent risk measures <span class="citation" data-cites="artzner1999">(<a href="#ref-artzner1999" role="doc-biblioref">Artzner et al. 1999</a>)</span>:</p>
<ol type="1">
<li><strong>Translation Invariance</strong>: <span class="math inline">\(\rho(X + c) = \rho(X) - c\)</span> for any constant <span class="math inline">\(c\)</span></li>
<li><strong>Positive Homogeneity</strong>: <span class="math inline">\(\rho(\lambda X) = \lambda \rho(X)\)</span> for <span class="math inline">\(\lambda &gt; 0\)</span></li>
<li><strong>Monotonicity</strong>: If <span class="math inline">\(X \leq Y\)</span> almost surely, then <span class="math inline">\(\rho(X) \geq \rho(Y)\)</span></li>
<li><strong>Subadditivity</strong>: <span class="math inline">\(\rho(X + Y) \leq \rho(X) + \rho(Y)\)</span></li>
</ol>
</section>
<section id="cvar-optimization-via-linear-programming" class="level4" data-number="2.2.3">
<h4 data-number="2.2.3" class="anchored" data-anchor-id="cvar-optimization-via-linear-programming"><span class="header-section-number">2.2.3</span> CVaR Optimization via Linear Programming</h4>
<p>A key insight from <span class="citation" data-cites="rockafellar2000">Rockafellar and Uryasev (<a href="#ref-rockafellar2000" role="doc-biblioref">2000</a>)</span> is that CVaR optimization can be reformulated as a linear programming problem. For discrete scenarios, the CVaR optimization problem becomes:</p>
<p><span id="eq-cvar-lp"><span class="math display">\[
\begin{align}
\min_{\mathbf{w}, \zeta, \mathbf{u}} &amp;\quad \zeta + \frac{1}{\alpha T} \sum_{t=1}^T u_t \\
\text{s.t.} &amp;\quad -\mathbf{w}^T \mathbf{r}_t - \zeta \leq u_t, \quad t = 1, \ldots, T \\
&amp;\quad u_t \geq 0, \quad t = 1, \ldots, T \\
&amp;\quad \mathbf{w}^T \mathbf{1} = 1 \\
&amp;\quad \mathbf{w} \geq 0
\end{align}
\tag{9}\]</span></span></p>
<p>where <span class="math inline">\(\zeta\)</span> represents the VaR, <span class="math inline">\(u_t\)</span> are auxiliary variables representing the excess losses, and <span class="math inline">\(T\)</span> is the number of scenarios.</p>
</section>
</section>
<section id="sec-genetic-algorithms" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="sec-genetic-algorithms"><span class="header-section-number">2.3</span> Genetic Algorithm Framework</h3>
<p>Genetic algorithms belong to the class of evolutionary algorithms inspired by natural selection. They are particularly useful for portfolio optimization when dealing with non-convex objectives, discrete constraints, or combinatorial problems.</p>
<section id="basic-ga-components" class="level4" data-number="2.3.1">
<h4 data-number="2.3.1" class="anchored" data-anchor-id="basic-ga-components"><span class="header-section-number">2.3.1</span> Basic GA Components</h4>
<ol type="1">
<li><strong>Chromosome Representation</strong>: Portfolio weights encoded as real-valued vectors</li>
<li><strong>Population</strong>: A collection of candidate solutions (portfolios)</li>
<li><strong>Fitness Function</strong>: Objective function to be optimized (e.g., Sharpe ratio)</li>
<li><strong>Selection</strong>: Mechanism for choosing parents for reproduction</li>
<li><strong>Crossover</strong>: Combining genetic material from parents to create offspring</li>
<li><strong>Mutation</strong>: Random alterations to maintain genetic diversity</li>
<li><strong>Replacement</strong>: Strategy for replacing old population with new offspring</li>
</ol>
</section>
<section id="ga-operators-for-portfolio-optimization" class="level4" data-number="2.3.2">
<h4 data-number="2.3.2" class="anchored" data-anchor-id="ga-operators-for-portfolio-optimization"><span class="header-section-number">2.3.2</span> GA Operators for Portfolio Optimization</h4>
<p><strong>Chromosome Encoding</strong>: Each portfolio is represented as a chromosome <span class="math inline">\(\mathbf{c} = (c_1, c_2, \ldots, c_n)\)</span> where <span class="math inline">\(c_i\)</span> represents the weight in asset <span class="math inline">\(i\)</span>.</p>
<p><strong>Normalization</strong>: To ensure <span class="math inline">\(\sum_{i=1}^n w_i = 1\)</span>, we normalize: <span id="eq-normalization"><span class="math display">\[
w_i = \frac{c_i}{\sum_{j=1}^n c_j}
\tag{10}\]</span></span></p>
<p><strong>Fitness Function</strong>: We use the negative Sharpe ratio as fitness: <span id="eq-fitness"><span class="math display">\[
f(\mathbf{w}) = -\frac{\mathbf{w}^T \boldsymbol{\mu} - r_f}{\sqrt{\mathbf{w}^T \boldsymbol{\Sigma} \mathbf{w}}}
\tag{11}\]</span></span></p>
<p>where <span class="math inline">\(r_f\)</span> is the risk-free rate.</p>
<p><strong>Crossover Operation</strong>: Blend crossover (BLX-α) for real-valued chromosomes: <span id="eq-crossover"><span class="math display">\[
\mathbf{c}_{child} = (1-\gamma)\mathbf{c}_{parent1} + \gamma\mathbf{c}_{parent2}
\tag{12}\]</span></span></p>
<p>where <span class="math inline">\(\gamma \sim U[-\alpha, 1+\alpha]\)</span> and <span class="math inline">\(\alpha\)</span> is typically 0.5.</p>
<p><strong>Mutation Operation</strong>: Gaussian mutation: <span id="eq-mutation"><span class="math display">\[
c_i' = c_i + \mathcal{N}(0, \sigma_m^2)
\tag{13}\]</span></span></p>
<p>where <span class="math inline">\(\sigma_m\)</span> is the mutation strength parameter.</p>
</section>
</section>
</section>
<section id="sec-data" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="sec-data"><span class="header-section-number">3</span> Data Acquisition and Preprocessing</h2>
<p>We construct a diversified portfolio of technology stocks to demonstrate our optimization techniques. The selected assets represent different segments of the technology sector and exhibit varying risk-return profiles.</p>
<div id="cell-fig-data-acquisition" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define our portfolio universe</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>tickers <span class="op">=</span> [<span class="st">'AAPL'</span>, <span class="st">'MSFT'</span>, <span class="st">'GOOGL'</span>, <span class="st">'AMZN'</span>, <span class="st">'NVDA'</span>, <span class="st">'META'</span>, <span class="st">'TSLA'</span>, <span class="st">'NFLX'</span>, <span class="st">'AMD'</span>, <span class="st">'CRM'</span>]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">'2020-01-01'</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> <span class="st">'2024-07-01'</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Download price data</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Downloading historical data..."</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>raw_data <span class="op">=</span> yf.download(tickers, start<span class="op">=</span>start_date, end<span class="op">=</span>end_date, auto_adjust<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Handle MultiIndex columns from yfinance</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">isinstance</span>(raw_data.columns, pd.MultiIndex):</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get adjusted close prices</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> raw_data[<span class="st">'Adj Close'</span>]</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Single ticker case</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> raw_data</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change().dropna()</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic statistics</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Data period: </span><span class="sc">{</span>returns<span class="sc">.</span>index[<span class="dv">0</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>returns<span class="sc">.</span>index[<span class="op">-</span><span class="dv">1</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of observations: </span><span class="sc">{</span><span class="bu">len</span>(returns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of assets: </span><span class="sc">{</span><span class="bu">len</span>(returns.columns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Create publication-quality visualization</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>fig, ((ax1, ax2), (ax3, ax4)) <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(hspace<span class="op">=</span><span class="fl">0.35</span>, wspace<span class="op">=</span><span class="fl">0.25</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Normalized price evolution</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>normalized_prices <span class="op">=</span> (data <span class="op">/</span> data.iloc[<span class="dv">0</span>]) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ticker <span class="kw">in</span> <span class="bu">enumerate</span>(tickers):</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    ax1.plot(normalized_prices.index, normalized_prices[ticker], </span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>             label<span class="op">=</span>ticker, linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Normalized Price Evolution (Base = 100)'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Normalized Price'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>ax1.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, ncol<span class="op">=</span><span class="dv">2</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>ax1.spines[<span class="st">'top'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>ax1.spines[<span class="st">'right'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: Correlation heatmap</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>corr_matrix <span class="op">=</span> returns.corr()</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> ax2.imshow(corr_matrix, cmap<span class="op">=</span><span class="st">'RdBu_r'</span>, aspect<span class="op">=</span><span class="st">'equal'</span>, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Return Correlation Matrix'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>ax2.set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(tickers)))</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>ax2.set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(tickers)))</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>ax2.set_xticklabels(tickers, rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>ax2.set_yticklabels(tickers, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Add colorbar</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> plt.colorbar(im, ax<span class="op">=</span>ax2, shrink<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>cbar.set_label(<span class="st">'Correlation'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 3: Return distribution (selected assets)  </span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>selected_assets <span class="op">=</span> [<span class="st">'AAPL'</span>, <span class="st">'MSFT'</span>, <span class="st">'GOOGL'</span>, <span class="st">'TSLA'</span>]</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> plt.cm.Set1(np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="bu">len</span>(selected_assets)))</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, asset <span class="kw">in</span> <span class="bu">enumerate</span>(selected_assets):</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> asset <span class="kw">in</span> returns.columns:</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>        ax3.hist(returns[asset], bins<span class="op">=</span><span class="dv">40</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, density<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span>asset, color<span class="op">=</span>colors[i], edgecolor<span class="op">=</span><span class="st">'white'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="st">'Daily Return Distributions'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>ax3.set_xlabel(<span class="st">'Daily Return'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>ax3.set_ylabel(<span class="st">'Density'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>ax3.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>ax3.spines[<span class="st">'top'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>ax3.spines[<span class="st">'right'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 4: Risk-Return scatter</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>mean_returns <span class="op">=</span> returns.mean() <span class="op">*</span> <span class="dv">252</span>  <span class="co"># Annualized  </span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>volatilities <span class="op">=</span> returns.std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)  <span class="co"># Annualized</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> plt.cm.Set1(np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="bu">len</span>(tickers)))</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>scatter <span class="op">=</span> ax4.scatter(volatilities, mean_returns, s<span class="op">=</span><span class="dv">100</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, c<span class="op">=</span>colors, </span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>                     edgecolors<span class="op">=</span><span class="st">'white'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>ax4.set_title(<span class="st">'Risk-Return Profile'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>ax4.set_xlabel(<span class="st">'Annualized Volatility'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>ax4.set_ylabel(<span class="st">'Annualized Expected Return'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels for each point with better positioning</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ticker <span class="kw">in</span> <span class="bu">enumerate</span>(tickers):</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    ax4.annotate(ticker, (volatilities[i], mean_returns[i]), </span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>                xytext<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>), textcoords<span class="op">=</span><span class="st">'offset points'</span>, fontsize<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>                fontweight<span class="op">=</span><span class="st">'bold'</span>, ha<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>ax4.spines[<span class="st">'top'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>ax4.spines[<span class="st">'right'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"PORTFOLIO SUMMARY STATISTICS (Annualized)"</span>)</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>summary_stats <span class="op">=</span> pd.DataFrame({</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Expected Return'</span>: mean_returns,</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: volatilities,</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: (mean_returns <span class="op">-</span> <span class="fl">0.02</span>) <span class="op">/</span> volatilities,  <span class="co"># Assuming 2% risk-free rate</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Min Daily Return'</span>: returns.<span class="bu">min</span>(),</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Daily Return'</span>: returns.<span class="bu">max</span>(),</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Skewness'</span>: returns.skew(),</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Kurtosis'</span>: returns.kurtosis()</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(summary_stats.<span class="bu">round</span>(<span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading historical data...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[                       0%                       ][**********            20%                       ]  2 of 10 completed[**************        30%                       ]  3 of 10 completed[*******************   40%                       ]  4 of 10 completed[**********************50%                       ]  5 of 10 completed[**********************60%****                   ]  6 of 10 completed[**********************70%*********              ]  7 of 10 completed[**********************80%*************          ]  8 of 10 completed[**********************90%******************     ]  9 of 10 completed[*********************100%***********************]  10 of 10 completed</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Data period: 2020-01-03 to 2024-06-28
Number of observations: 1129
Number of assets: 10</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-data-acquisition" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-data-acquisition-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-data-acquisition-output-4.png" width="1537" height="1046" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-data-acquisition-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Historical price data and returns for technology portfolio
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
============================================================
PORTFOLIO SUMMARY STATISTICS (Annualized)
============================================================
        Expected Return  Volatility  Sharpe Ratio  Min Daily Return  \
Ticker                                                                
AAPL             0.2901      0.3270        0.8259           -0.1286   
AMD              0.4068      0.5302        0.7295           -0.1464   
AMZN             0.2253      0.3651        0.5623           -0.1405   
CRM              0.1803      0.4094        0.3915           -0.1974   
GOOGL            0.2733      0.3300        0.7677           -0.1163   
META             0.3047      0.4627        0.6153           -0.2639   
MSFT             0.2869      0.3141        0.8499           -0.1474   
NFLX             0.2751      0.4713        0.5413           -0.3512   
NVDA             0.8217      0.5407        1.4828           -0.1845   
TSLA             0.6528      0.6662        0.9500           -0.2106   

        Max Daily Return  Skewness  Kurtosis  
Ticker                                        
AAPL              0.1198    0.1288    5.0443  
AMD               0.1650    0.2196    2.1543  
AMZN              0.1354    0.1202    3.9909  
CRM               0.2604    0.3434   14.6727  
GOOGL             0.1022   -0.0540    3.6519  
META              0.2328   -0.2969   17.7454  
MSFT              0.1422    0.0082    6.8824  
NFLX              0.1685   -1.3045   22.3826  
NVDA              0.2437    0.4463    4.2673  
TSLA              0.1989    0.1318    3.0202  </code></pre>
</div>
</div>
</section>
<section id="sec-shrinkage" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="sec-shrinkage"><span class="header-section-number">4</span> Covariance Matrix Estimation and Shrinkage</h2>
<p>One of the fundamental challenges in portfolio optimization is the estimation of the covariance matrix. The sample covariance matrix, while unbiased, can be highly unstable, especially when the number of assets approaches the number of observations. This leads to extreme portfolio weights and poor out-of-sample performance.</p>
<section id="the-curse-of-dimensionality-in-covariance-estimation" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="the-curse-of-dimensionality-in-covariance-estimation"><span class="header-section-number">4.1</span> The Curse of Dimensionality in Covariance Estimation</h3>
<p>For a portfolio of <span class="math inline">\(n\)</span> assets with <span class="math inline">\(T\)</span> observations, the sample covariance matrix <span class="math inline">\(\hat{\mathbf{\Sigma}}\)</span> requires estimating <span class="math inline">\(\frac{n(n+1)}{2}\)</span> unique parameters. When <span class="math inline">\(n\)</span> is large relative to <span class="math inline">\(T\)</span>, the sample covariance matrix becomes singular or poorly conditioned, leading to unstable portfolio optimization results.</p>
<section id="mathematical-framework" class="level4" data-number="4.1.1">
<h4 data-number="4.1.1" class="anchored" data-anchor-id="mathematical-framework"><span class="header-section-number">4.1.1</span> Mathematical Framework</h4>
<p>The sample covariance matrix is given by: <span id="eq-sample-cov"><span class="math display">\[
\hat{\mathbf{\Sigma}} = \frac{1}{T-1}\sum_{t=1}^T (\mathbf{r}_t - \hat{\boldsymbol{\mu}})(\mathbf{r}_t - \hat{\boldsymbol{\mu}})^T
\tag{14}\]</span></span></p>
<p>However, this estimator has several problems: - <strong>High variance</strong>: Especially for small samples or high dimensions - <strong>Extreme eigenvalues</strong>: Leading to concentrated portfolios - <strong>Instability</strong>: Small changes in data cause large changes in optimal weights</p>
</section>
</section>
<section id="shrinkage-estimation" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="shrinkage-estimation"><span class="header-section-number">4.2</span> Shrinkage Estimation</h3>
<p>Shrinkage estimation, pioneered by <span class="citation" data-cites="ledoit2003improved">Ledoit and Wolf (<a href="#ref-ledoit2003improved" role="doc-biblioref">2003</a>)</span> and <span class="citation" data-cites="ledoit2004well">Ledoit and Wolf (<a href="#ref-ledoit2004well" role="doc-biblioref">2004</a>)</span>, provides a solution by combining the sample covariance matrix with a structured target matrix.</p>
<section id="ledoit-wolf-shrinkage" class="level4" data-number="4.2.1">
<h4 data-number="4.2.1" class="anchored" data-anchor-id="ledoit-wolf-shrinkage"><span class="header-section-number">4.2.1</span> Ledoit-Wolf Shrinkage</h4>
<p>The shrinkage estimator takes the form: <span id="eq-shrinkage"><span class="math display">\[
\hat{\mathbf{\Sigma}}_{\text{shrink}} = (1-\rho)\hat{\mathbf{\Sigma}} + \rho\mathbf{F}
\tag{15}\]</span></span></p>
<p>where: - <span class="math inline">\(\hat{\mathbf{\Sigma}}\)</span> is the sample covariance matrix - <span class="math inline">\(\mathbf{F}\)</span> is the shrinkage target (e.g., identity matrix, single-factor model) - <span class="math inline">\(\rho \in [0,1]\)</span> is the shrinkage intensity</p>
</section>
<section id="optimal-shrinkage-intensity" class="level4" data-number="4.2.2">
<h4 data-number="4.2.2" class="anchored" data-anchor-id="optimal-shrinkage-intensity"><span class="header-section-number">4.2.2</span> Optimal Shrinkage Intensity</h4>
<p><span class="citation" data-cites="ledoit2004well">Ledoit and Wolf (<a href="#ref-ledoit2004well" role="doc-biblioref">2004</a>)</span> derived the optimal shrinkage intensity that minimizes the expected quadratic loss: <span id="eq-optimal-rho"><span class="math display">\[
\rho^* = \frac{\sum_{i,j}\text{Var}(\hat{\sigma}_{ij})}{\sum_{i,j}(\hat{\sigma}_{ij} - f_{ij})^2}
\tag{16}\]</span></span></p>
<p>where <span class="math inline">\(f_{ij}\)</span> are the elements of the target matrix <span class="math inline">\(\mathbf{F}\)</span>.</p>
<div id="cell-fig-shrinkage-analysis" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CovarianceShrinkage:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Implementation of Ledoit-Wolf shrinkage estimation for covariance matrices.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, returns_data):</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Initialize shrinkage estimator.</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">        returns_data : pandas.DataFrame</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">            Historical returns data</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.returns <span class="op">=</span> returns_data</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_assets <span class="op">=</span> <span class="bu">len</span>(returns_data.columns)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_obs <span class="op">=</span> <span class="bu">len</span>(returns_data)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sample_covariance(<span class="va">self</span>):</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate sample covariance matrix."""</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.returns.cov().values</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> identity_target(<span class="va">self</span>):</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Identity matrix target (Ledoit-Wolf)."""</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        sample_cov <span class="op">=</span> <span class="va">self</span>.sample_covariance()</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        trace <span class="op">=</span> np.trace(sample_cov)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (trace <span class="op">/</span> <span class="va">self</span>.n_assets) <span class="op">*</span> np.eye(<span class="va">self</span>.n_assets)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> single_factor_target(<span class="va">self</span>):</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Single factor model target."""</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        sample_cov <span class="op">=</span> <span class="va">self</span>.sample_covariance()</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Estimate factor loadings via PCA</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        eigenvals, eigenvecs <span class="op">=</span> np.linalg.eigh(sample_cov)</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        factor_loading <span class="op">=</span> eigenvecs[:, <span class="op">-</span><span class="dv">1</span>] <span class="op">*</span> np.sqrt(eigenvals[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Single factor covariance matrix</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        factor_var <span class="op">=</span> eigenvals[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        residual_var <span class="op">=</span> np.mean(eigenvals[:<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        target <span class="op">=</span> np.outer(factor_loading, factor_loading) <span class="op">+</span> residual_var <span class="op">*</span> np.eye(<span class="va">self</span>.n_assets)</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> target</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> constant_correlation_target(<span class="va">self</span>):</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Constant correlation target."""</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        sample_cov <span class="op">=</span> <span class="va">self</span>.sample_covariance()</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Average variance and correlation</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        avg_var <span class="op">=</span> np.mean(np.diag(sample_cov))</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>        avg_corr <span class="op">=</span> (np.<span class="bu">sum</span>(sample_cov) <span class="op">-</span> np.trace(sample_cov)) <span class="op">/</span> (<span class="va">self</span>.n_assets <span class="op">*</span> (<span class="va">self</span>.n_assets <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Constant correlation matrix</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>        target <span class="op">=</span> avg_corr <span class="op">*</span> np.ones((<span class="va">self</span>.n_assets, <span class="va">self</span>.n_assets))</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        np.fill_diagonal(target, <span class="fl">1.0</span>)</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>        target <span class="op">*=</span> avg_var</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> target</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> optimal_shrinkage_intensity(<span class="va">self</span>, target_matrix):</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a><span class="co">        Calculate optimal shrinkage intensity (Ledoit-Wolf).</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a><span class="co">        target_matrix : numpy.ndarray</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a><span class="co">            Target matrix for shrinkage</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a><span class="co">        --------</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a><span class="co">        float: Optimal shrinkage intensity</span></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>        sample_cov <span class="op">=</span> <span class="va">self</span>.sample_covariance()</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>        returns_centered <span class="op">=</span> <span class="va">self</span>.returns <span class="op">-</span> <span class="va">self</span>.returns.mean()</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate numerator: sum of variances of sample covariance elements</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>        numerator <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.n_assets):</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.n_assets):</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> i <span class="op">==</span> j:</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Variance of sample variance</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>                    xi_sq <span class="op">=</span> (returns_centered.iloc[:, i]<span class="op">**</span><span class="dv">2</span>).values</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>                    numerator <span class="op">+=</span> np.var(xi_sq) <span class="op">/</span> <span class="va">self</span>.n_obs</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Variance of sample covariance</span></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>                    xi_xj <span class="op">=</span> (returns_centered.iloc[:, i] <span class="op">*</span> returns_centered.iloc[:, j]).values</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>                    numerator <span class="op">+=</span> np.var(xi_xj) <span class="op">/</span> <span class="va">self</span>.n_obs</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate denominator: squared Frobenius norm of difference</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>        denominator <span class="op">=</span> np.<span class="bu">sum</span>((sample_cov <span class="op">-</span> target_matrix)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Optimal shrinkage intensity</span></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>        rho <span class="op">=</span> <span class="bu">min</span>(numerator <span class="op">/</span> denominator, <span class="fl">1.0</span>) <span class="cf">if</span> denominator <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">max</span>(rho, <span class="fl">0.0</span>)</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> shrinkage_estimator(<span class="va">self</span>, target_type<span class="op">=</span><span class="st">'identity'</span>):</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a><span class="co">        Compute shrinkage covariance matrix.</span></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a><span class="co">        target_type : str</span></span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a><span class="co">            Type of target matrix ('identity', 'single_factor', 'constant_corr')</span></span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a><span class="co">        --------</span></span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a><span class="co">        tuple: (shrinkage_matrix, shrinkage_intensity)</span></span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>        sample_cov <span class="op">=</span> <span class="va">self</span>.sample_covariance()</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> target_type <span class="op">==</span> <span class="st">'identity'</span>:</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>            target <span class="op">=</span> <span class="va">self</span>.identity_target()</span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> target_type <span class="op">==</span> <span class="st">'single_factor'</span>:</span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>            target <span class="op">=</span> <span class="va">self</span>.single_factor_target()</span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> target_type <span class="op">==</span> <span class="st">'constant_corr'</span>:</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>            target <span class="op">=</span> <span class="va">self</span>.constant_correlation_target()</span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Invalid target type"</span>)</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>        rho <span class="op">=</span> <span class="va">self</span>.optimal_shrinkage_intensity(target)</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>        shrinkage_cov <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> rho) <span class="op">*</span> sample_cov <span class="op">+</span> rho <span class="op">*</span> target</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> shrinkage_cov, rho</span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize shrinkage estimator</span></span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>shrinkage_estimator <span class="op">=</span> CovarianceShrinkage(returns)</span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate different shrinkage estimators</span></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>sample_cov <span class="op">=</span> shrinkage_estimator.sample_covariance()</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>identity_shrink, rho_identity <span class="op">=</span> shrinkage_estimator.shrinkage_estimator(<span class="st">'identity'</span>)</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>factor_shrink, rho_factor <span class="op">=</span> shrinkage_estimator.shrinkage_estimator(<span class="st">'single_factor'</span>)</span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>const_corr_shrink, rho_const <span class="op">=</span> shrinkage_estimator.shrinkage_estimator(<span class="st">'constant_corr'</span>)</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a><span class="co"># Create comprehensive visualization</span></span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">10</span>))</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>gs <span class="op">=</span> fig.add_gridspec(<span class="dv">3</span>, <span class="dv">3</span>, hspace<span class="op">=</span><span class="fl">0.4</span>, wspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Sample covariance matrix</span></span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>im1 <span class="op">=</span> ax1.imshow(sample_cov, cmap<span class="op">=</span><span class="st">'RdBu_r'</span>, aspect<span class="op">=</span><span class="st">'equal'</span>)</span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Sample Covariance Matrix'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>ax1.set_xticks(<span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(tickers), <span class="dv">2</span>))</span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>ax1.set_yticks(<span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(tickers), <span class="dv">2</span>))</span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>ax1.set_xticklabels([tickers[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(tickers), <span class="dv">2</span>)], rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a>ax1.set_yticklabels([tickers[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(tickers), <span class="dv">2</span>)])</span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: Identity shrinkage</span></span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>im2 <span class="op">=</span> ax2.imshow(identity_shrink, cmap<span class="op">=</span><span class="st">'RdBu_r'</span>, aspect<span class="op">=</span><span class="st">'equal'</span>)</span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="ss">f'Identity Shrinkage (ρ=</span><span class="sc">{</span>rho_identity<span class="sc">:.3f}</span><span class="ss">)'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>ax2.set_xticks(<span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(tickers), <span class="dv">2</span>))</span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>ax2.set_yticks(<span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(tickers), <span class="dv">2</span>))</span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>ax2.set_xticklabels([tickers[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(tickers), <span class="dv">2</span>)], rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>ax2.set_yticklabels([tickers[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(tickers), <span class="dv">2</span>)])</span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 3: Constant correlation shrinkage</span></span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>ax3 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, <span class="dv">2</span>])</span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>im3 <span class="op">=</span> ax3.imshow(const_corr_shrink, cmap<span class="op">=</span><span class="st">'RdBu_r'</span>, aspect<span class="op">=</span><span class="st">'equal'</span>)</span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="ss">f'Constant Corr. (ρ=</span><span class="sc">{</span>rho_const<span class="sc">:.3f}</span><span class="ss">)'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>ax3.set_xticks(<span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(tickers), <span class="dv">2</span>))</span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>ax3.set_yticks(<span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(tickers), <span class="dv">2</span>))</span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>ax3.set_xticklabels([tickers[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(tickers), <span class="dv">2</span>)], rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>ax3.set_yticklabels([tickers[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(tickers), <span class="dv">2</span>)])</span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 4: Eigenvalue comparison</span></span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>ax4 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, :])</span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>eigenvals_sample <span class="op">=</span> np.linalg.eigvals(sample_cov)</span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>eigenvals_identity <span class="op">=</span> np.linalg.eigvals(identity_shrink)</span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>eigenvals_const <span class="op">=</span> np.linalg.eigvals(const_corr_shrink)</span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(eigenvals_sample))</span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>ax4.plot(x, np.sort(eigenvals_sample)[::<span class="op">-</span><span class="dv">1</span>], <span class="st">'o-'</span>, label<span class="op">=</span><span class="st">'Sample'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>ax4.plot(x, np.sort(eigenvals_identity)[::<span class="op">-</span><span class="dv">1</span>], <span class="st">'s-'</span>, label<span class="op">=</span><span class="st">'Identity Shrinkage'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>ax4.plot(x, np.sort(eigenvals_const)[::<span class="op">-</span><span class="dv">1</span>], <span class="st">'^-'</span>, label<span class="op">=</span><span class="st">'Constant Correlation'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>ax4.set_title(<span class="st">'Eigenvalue Comparison'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>ax4.set_xlabel(<span class="st">'Eigenvalue Index'</span>)</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>ax4.set_ylabel(<span class="st">'Eigenvalue'</span>)</span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a>ax4.set_yscale(<span class="st">'log'</span>)</span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a>ax4.legend(frameon<span class="op">=</span><span class="va">True</span>, fancybox<span class="op">=</span><span class="va">True</span>, shadow<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 5: Portfolio weight comparison</span></span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>ax5 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, :<span class="dv">2</span>])</span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate minimum variance portfolios for each estimator</span></span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> min_var_weights(cov_matrix):</span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a>    inv_cov <span class="op">=</span> np.linalg.inv(cov_matrix)</span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>    ones <span class="op">=</span> np.ones((<span class="bu">len</span>(cov_matrix), <span class="dv">1</span>))</span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> (inv_cov <span class="op">@</span> ones) <span class="op">/</span> (ones.T <span class="op">@</span> inv_cov <span class="op">@</span> ones)</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> weights.flatten()</span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>weights_sample <span class="op">=</span> min_var_weights(sample_cov)</span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a>weights_identity <span class="op">=</span> min_var_weights(identity_shrink)</span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a>weights_const <span class="op">=</span> min_var_weights(const_corr_shrink)</span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(tickers))</span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a>ax5.bar(x <span class="op">-</span> width, weights_sample, width, label<span class="op">=</span><span class="st">'Sample'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a>ax5.bar(x, weights_identity, width, label<span class="op">=</span><span class="st">'Identity Shrinkage'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a>ax5.bar(x <span class="op">+</span> width, weights_const, width, label<span class="op">=</span><span class="st">'Constant Correlation'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a>ax5.set_title(<span class="st">'Minimum Variance Portfolio Weights'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a>ax5.set_xlabel(<span class="st">'Assets'</span>)</span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a>ax5.set_ylabel(<span class="st">'Portfolio Weight'</span>)</span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true" tabindex="-1"></a>ax5.set_xticks(x)</span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true" tabindex="-1"></a>ax5.set_xticklabels(tickers, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true" tabindex="-1"></a>ax5.legend(frameon<span class="op">=</span><span class="va">True</span>, fancybox<span class="op">=</span><span class="va">True</span>, shadow<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 6: Condition number comparison</span></span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true" tabindex="-1"></a>ax6 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">2</span>])</span>
<span id="cb6-210"><a href="#cb6-210" aria-hidden="true" tabindex="-1"></a>cond_numbers <span class="op">=</span> [</span>
<span id="cb6-211"><a href="#cb6-211" aria-hidden="true" tabindex="-1"></a>    np.linalg.cond(sample_cov),</span>
<span id="cb6-212"><a href="#cb6-212" aria-hidden="true" tabindex="-1"></a>    np.linalg.cond(identity_shrink),</span>
<span id="cb6-213"><a href="#cb6-213" aria-hidden="true" tabindex="-1"></a>    np.linalg.cond(const_corr_shrink)</span>
<span id="cb6-214"><a href="#cb6-214" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb6-215"><a href="#cb6-215" aria-hidden="true" tabindex="-1"></a>methods <span class="op">=</span> [<span class="st">'Sample'</span>, <span class="st">'Identity</span><span class="ch">\n</span><span class="st">Shrinkage'</span>, <span class="st">'Constant</span><span class="ch">\n</span><span class="st">Correlation'</span>]</span>
<span id="cb6-216"><a href="#cb6-216" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'#ff7f0e'</span>, <span class="st">'#2ca02c'</span>, <span class="st">'#d62728'</span>]</span>
<span id="cb6-217"><a href="#cb6-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-218"><a href="#cb6-218" aria-hidden="true" tabindex="-1"></a>bars <span class="op">=</span> ax6.bar(methods, cond_numbers, color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.8</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb6-219"><a href="#cb6-219" aria-hidden="true" tabindex="-1"></a>ax6.set_title(<span class="st">'Condition Numbers'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb6-220"><a href="#cb6-220" aria-hidden="true" tabindex="-1"></a>ax6.set_ylabel(<span class="st">'Condition Number'</span>)</span>
<span id="cb6-221"><a href="#cb6-221" aria-hidden="true" tabindex="-1"></a>ax6.set_yscale(<span class="st">'log'</span>)</span>
<span id="cb6-222"><a href="#cb6-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-223"><a href="#cb6-223" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels on bars</span></span>
<span id="cb6-224"><a href="#cb6-224" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bar, value <span class="kw">in</span> <span class="bu">zip</span>(bars, cond_numbers):</span>
<span id="cb6-225"><a href="#cb6-225" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> bar.get_height()</span>
<span id="cb6-226"><a href="#cb6-226" aria-hidden="true" tabindex="-1"></a>    ax6.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height,</span>
<span id="cb6-227"><a href="#cb6-227" aria-hidden="true" tabindex="-1"></a>             <span class="ss">f'</span><span class="sc">{</span>value<span class="sc">:.0f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb6-228"><a href="#cb6-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-229"><a href="#cb6-229" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb6-230"><a href="#cb6-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-231"><a href="#cb6-231" aria-hidden="true" tabindex="-1"></a><span class="co"># Print numerical results</span></span>
<span id="cb6-232"><a href="#cb6-232" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb6-233"><a href="#cb6-233" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"COVARIANCE MATRIX SHRINKAGE ANALYSIS"</span>)</span>
<span id="cb6-234"><a href="#cb6-234" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb6-235"><a href="#cb6-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-236"><a href="#cb6-236" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Shrinkage Intensities:"</span>)</span>
<span id="cb6-237"><a href="#cb6-237" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Identity Target: </span><span class="sc">{</span>rho_identity<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb6-238"><a href="#cb6-238" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Single Factor Target: </span><span class="sc">{</span>rho_factor<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb6-239"><a href="#cb6-239" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Constant Correlation Target: </span><span class="sc">{</span>rho_const<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb6-240"><a href="#cb6-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-241"><a href="#cb6-241" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Condition Numbers:"</span>)</span>
<span id="cb6-242"><a href="#cb6-242" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sample Covariance: </span><span class="sc">{</span>np<span class="sc">.</span>linalg<span class="sc">.</span>cond(sample_cov)<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb6-243"><a href="#cb6-243" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Identity Shrinkage: </span><span class="sc">{</span>np<span class="sc">.</span>linalg<span class="sc">.</span>cond(identity_shrink)<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb6-244"><a href="#cb6-244" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Constant Correlation: </span><span class="sc">{</span>np<span class="sc">.</span>linalg<span class="sc">.</span>cond(const_corr_shrink)<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb6-245"><a href="#cb6-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-246"><a href="#cb6-246" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Portfolio Concentration (Max Weight):"</span>)</span>
<span id="cb6-247"><a href="#cb6-247" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sample Covariance: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(np.<span class="bu">abs</span>(weights_sample))<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb6-248"><a href="#cb6-248" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Identity Shrinkage: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(np.<span class="bu">abs</span>(weights_identity))<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb6-249"><a href="#cb6-249" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Constant Correlation: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(np.<span class="bu">abs</span>(weights_const))<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-shrinkage-analysis" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-shrinkage-analysis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-shrinkage-analysis-output-1.png" width="1737" height="1325" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-shrinkage-analysis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Covariance matrix shrinkage estimation and portfolio impact
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
COVARIANCE MATRIX SHRINKAGE ANALYSIS
======================================================================

Shrinkage Intensities:
Identity Target: 0.0112
Single Factor Target: 0.2092
Constant Correlation Target: 0.0112

Condition Numbers:
Sample Covariance: 60.45
Identity Shrinkage: 54.14
Constant Correlation: 54.14

Portfolio Concentration (Max Weight):
Sample Covariance: 0.3649
Identity Shrinkage: 0.3525
Constant Correlation: 0.3525</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="sec-mv-implementation" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="sec-mv-implementation"><span class="header-section-number">5</span> Mean-Variance Optimization Implementation</h2>
<p>We implement the classical Markowitz mean-variance optimization framework, providing both analytical and numerical solutions.</p>
<div id="cell-fig-markowitz-optimization" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MarkowitzOptimizer:</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Classical Markowitz mean-variance optimizer with analytical and numerical solutions.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, returns_data):</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Initialize the optimizer with historical returns data.</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">        returns_data : pandas.DataFrame</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">            Historical returns data with assets as columns</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.returns <span class="op">=</span> returns_data</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mean_returns <span class="op">=</span> returns_data.mean() <span class="op">*</span> <span class="dv">252</span>  <span class="co"># Annualized</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cov_matrix <span class="op">=</span> returns_data.cov() <span class="op">*</span> <span class="dv">252</span>     <span class="co"># Annualized</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_assets <span class="op">=</span> <span class="bu">len</span>(returns_data.columns)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate key matrices for analytical solution</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.inv_cov <span class="op">=</span> np.linalg.inv(<span class="va">self</span>.cov_matrix)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ones <span class="op">=</span> np.ones((<span class="va">self</span>.n_assets, <span class="dv">1</span>))</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate constants A, B, C for analytical solution</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.A <span class="op">=</span> <span class="bu">float</span>(<span class="va">self</span>.ones.T <span class="op">@</span> <span class="va">self</span>.inv_cov <span class="op">@</span> <span class="va">self</span>.ones)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.B <span class="op">=</span> <span class="bu">float</span>(<span class="va">self</span>.ones.T <span class="op">@</span> <span class="va">self</span>.inv_cov <span class="op">@</span> <span class="va">self</span>.mean_returns.values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.C <span class="op">=</span> <span class="bu">float</span>(<span class="va">self</span>.mean_returns.values.T <span class="op">@</span> <span class="va">self</span>.inv_cov <span class="op">@</span> <span class="va">self</span>.mean_returns.values)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.discriminant <span class="op">=</span> <span class="va">self</span>.A <span class="op">*</span> <span class="va">self</span>.C <span class="op">-</span> <span class="va">self</span>.B<span class="op">**</span><span class="dv">2</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> min_variance_portfolio(<span class="va">self</span>):</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co">        Calculate the global minimum variance portfolio.</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="co">        --------</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Portfolio weights, expected return, and volatility</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> (<span class="va">self</span>.inv_cov <span class="op">@</span> <span class="va">self</span>.ones) <span class="op">/</span> <span class="va">self</span>.A</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> weights.flatten()</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        expected_return <span class="op">=</span> np.<span class="bu">sum</span>(weights <span class="op">*</span> <span class="va">self</span>.mean_returns)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        volatility <span class="op">=</span> np.sqrt(weights.T <span class="op">@</span> <span class="va">self</span>.cov_matrix <span class="op">@</span> weights)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">'weights'</span>: pd.Series(weights, index<span class="op">=</span><span class="va">self</span>.returns.columns),</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">'expected_return'</span>: expected_return,</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">'volatility'</span>: volatility,</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">'sharpe_ratio'</span>: (expected_return <span class="op">-</span> <span class="fl">0.02</span>) <span class="op">/</span> volatility</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tangency_portfolio(<span class="va">self</span>, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>):</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="co">        Calculate the tangency (maximum Sharpe ratio) portfolio.</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="co">        risk_free_rate : float</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="co">            Risk-free rate for Sharpe ratio calculation</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a><span class="co">        --------</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Portfolio weights, expected return, and volatility</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>        excess_returns <span class="op">=</span> <span class="va">self</span>.mean_returns <span class="op">-</span> risk_free_rate</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> (<span class="va">self</span>.inv_cov <span class="op">@</span> excess_returns) <span class="op">/</span> (<span class="va">self</span>.ones.T <span class="op">@</span> <span class="va">self</span>.inv_cov <span class="op">@</span> excess_returns)</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> weights.flatten()</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>        expected_return <span class="op">=</span> np.<span class="bu">sum</span>(weights <span class="op">*</span> <span class="va">self</span>.mean_returns)</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>        volatility <span class="op">=</span> np.sqrt(weights.T <span class="op">@</span> <span class="va">self</span>.cov_matrix <span class="op">@</span> weights)</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>            <span class="st">'weights'</span>: pd.Series(weights, index<span class="op">=</span><span class="va">self</span>.returns.columns),</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">'expected_return'</span>: expected_return,</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>            <span class="st">'volatility'</span>: volatility,</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>            <span class="st">'sharpe_ratio'</span>: (expected_return <span class="op">-</span> risk_free_rate) <span class="op">/</span> volatility</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> efficient_portfolio(<span class="va">self</span>, target_return):</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a><span class="co">        Calculate efficient portfolio for a given target return.</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a><span class="co">        target_return : float</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a><span class="co">            Target expected return</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a><span class="co">        --------</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Portfolio weights, expected return, and volatility</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Analytical solution</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>        lambda1 <span class="op">=</span> (<span class="va">self</span>.C <span class="op">-</span> <span class="va">self</span>.B <span class="op">*</span> target_return) <span class="op">/</span> <span class="va">self</span>.discriminant</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>        lambda2 <span class="op">=</span> (<span class="va">self</span>.A <span class="op">*</span> target_return <span class="op">-</span> <span class="va">self</span>.B) <span class="op">/</span> <span class="va">self</span>.discriminant</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> lambda1 <span class="op">*</span> (<span class="va">self</span>.inv_cov <span class="op">@</span> <span class="va">self</span>.ones).flatten() <span class="op">+</span> <span class="op">\</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>                 lambda2 <span class="op">*</span> (<span class="va">self</span>.inv_cov <span class="op">@</span> <span class="va">self</span>.mean_returns.values)</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>        expected_return <span class="op">=</span> np.<span class="bu">sum</span>(weights <span class="op">*</span> <span class="va">self</span>.mean_returns)</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>        volatility <span class="op">=</span> np.sqrt(weights.T <span class="op">@</span> <span class="va">self</span>.cov_matrix <span class="op">@</span> weights)</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>            <span class="st">'weights'</span>: pd.Series(weights, index<span class="op">=</span><span class="va">self</span>.returns.columns),</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>            <span class="st">'expected_return'</span>: expected_return,</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>            <span class="st">'volatility'</span>: volatility,</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>            <span class="st">'sharpe_ratio'</span>: (expected_return <span class="op">-</span> <span class="fl">0.02</span>) <span class="op">/</span> volatility</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> efficient_frontier(<span class="va">self</span>, n_points<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a><span class="co">        Generate the efficient frontier.</span></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a><span class="co">        n_points : int</span></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a><span class="co">            Number of points on the efficient frontier</span></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a><span class="co">        --------</span></span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a><span class="co">        pandas.DataFrame: Expected returns, volatilities, and Sharpe ratios</span></span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>        min_ret <span class="op">=</span> <span class="va">self</span>.mean_returns.<span class="bu">min</span>()</span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>        max_ret <span class="op">=</span> <span class="va">self</span>.mean_returns.<span class="bu">max</span>()</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>        target_returns <span class="op">=</span> np.linspace(min_ret, max_ret, n_points)</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>        efficient_portfolios <span class="op">=</span> []</span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> target_ret <span class="kw">in</span> target_returns:</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>                portfolio <span class="op">=</span> <span class="va">self</span>.efficient_portfolio(target_ret)</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>                efficient_portfolios.append({</span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Expected_Return'</span>: portfolio[<span class="st">'expected_return'</span>],</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Volatility'</span>: portfolio[<span class="st">'volatility'</span>],</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Sharpe_Ratio'</span>: portfolio[<span class="st">'sharpe_ratio'</span>]</span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame(efficient_portfolios)</span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize optimizer</span></span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>mv_optimizer <span class="op">=</span> MarkowitzOptimizer(returns)</span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate special portfolios</span></span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>min_var_portfolio <span class="op">=</span> mv_optimizer.min_variance_portfolio()</span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>tangency_portfolio <span class="op">=</span> mv_optimizer.tangency_portfolio()</span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate efficient frontier</span></span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>efficient_frontier <span class="op">=</span> mv_optimizer.efficient_frontier()</span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Nature-quality visualization</span></span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>fig, ((ax1, ax2), (ax3, ax4)) <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(hspace<span class="op">=</span><span class="fl">0.35</span>, wspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Efficient frontier with special portfolios</span></span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a>ax1.plot(efficient_frontier[<span class="st">'Volatility'</span>], efficient_frontier[<span class="st">'Expected_Return'</span>], </span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a>         <span class="st">'b-'</span>, linewidth<span class="op">=</span><span class="dv">3</span>, label<span class="op">=</span><span class="st">'Efficient Frontier'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a>ax1.scatter(volatilities, mean_returns, alpha<span class="op">=</span><span class="fl">0.7</span>, s<span class="op">=</span><span class="dv">80</span>, c<span class="op">=</span><span class="st">'gray'</span>, </span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a>           label<span class="op">=</span><span class="st">'Individual Assets'</span>, edgecolors<span class="op">=</span><span class="st">'white'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a>ax1.scatter(min_var_portfolio[<span class="st">'volatility'</span>], min_var_portfolio[<span class="st">'expected_return'</span>], </span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'red'</span>, s<span class="op">=</span><span class="dv">150</span>, marker<span class="op">=</span><span class="st">'*'</span>, label<span class="op">=</span><span class="st">'Min Variance'</span>, zorder<span class="op">=</span><span class="dv">5</span>, </span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>            edgecolors<span class="op">=</span><span class="st">'white'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>ax1.scatter(tangency_portfolio[<span class="st">'volatility'</span>], tangency_portfolio[<span class="st">'expected_return'</span>], </span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'gold'</span>, s<span class="op">=</span><span class="dv">150</span>, marker<span class="op">=</span><span class="st">'*'</span>, label<span class="op">=</span><span class="st">'Tangency'</span>, zorder<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a>            edgecolors<span class="op">=</span><span class="st">'white'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Add selected asset labels with better styling</span></span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a>selected_tickers <span class="op">=</span> [<span class="st">'AAPL'</span>, <span class="st">'MSFT'</span>, <span class="st">'GOOGL'</span>, <span class="st">'TSLA'</span>]</span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ticker <span class="kw">in</span> <span class="bu">enumerate</span>(tickers):</span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ticker <span class="kw">in</span> selected_tickers:</span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>        ax1.annotate(ticker, (volatilities[i], mean_returns[i]), </span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a>                    xytext<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>), textcoords<span class="op">=</span><span class="st">'offset points'</span>, fontsize<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a>                    fontweight<span class="op">=</span><span class="st">'bold'</span>, ha<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Volatility (Annualized)'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Expected Return (Annualized)'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Mean-Variance Efficient Frontier'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a>ax1.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a>ax1.spines[<span class="st">'top'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb8-180"><a href="#cb8-180" aria-hidden="true" tabindex="-1"></a>ax1.spines[<span class="st">'right'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb8-181"><a href="#cb8-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-182"><a href="#cb8-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: Portfolio weights comparison</span></span>
<span id="cb8-183"><a href="#cb8-183" aria-hidden="true" tabindex="-1"></a>portfolio_weights <span class="op">=</span> pd.DataFrame({</span>
<span id="cb8-184"><a href="#cb8-184" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Min Variance'</span>: min_var_portfolio[<span class="st">'weights'</span>],  </span>
<span id="cb8-185"><a href="#cb8-185" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Tangency'</span>: tangency_portfolio[<span class="st">'weights'</span>]</span>
<span id="cb8-186"><a href="#cb8-186" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb8-187"><a href="#cb8-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(tickers))</span>
<span id="cb8-189"><a href="#cb8-189" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb8-190"><a href="#cb8-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-191"><a href="#cb8-191" aria-hidden="true" tabindex="-1"></a>bars1 <span class="op">=</span> ax2.bar(x <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>, portfolio_weights[<span class="st">'Min Variance'</span>], width, </span>
<span id="cb8-192"><a href="#cb8-192" aria-hidden="true" tabindex="-1"></a>               label<span class="op">=</span><span class="st">'Min Variance'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-193"><a href="#cb8-193" aria-hidden="true" tabindex="-1"></a>bars2 <span class="op">=</span> ax2.bar(x <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span>, portfolio_weights[<span class="st">'Tangency'</span>], width, </span>
<span id="cb8-194"><a href="#cb8-194" aria-hidden="true" tabindex="-1"></a>               label<span class="op">=</span><span class="st">'Tangency'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-195"><a href="#cb8-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-196"><a href="#cb8-196" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Assets'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb8-197"><a href="#cb8-197" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Portfolio Weight'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb8-198"><a href="#cb8-198" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Optimal Portfolio Weights'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb8-199"><a href="#cb8-199" aria-hidden="true" tabindex="-1"></a>ax2.set_xticks(x)</span>
<span id="cb8-200"><a href="#cb8-200" aria-hidden="true" tabindex="-1"></a>ax2.set_xticklabels(tickers, rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb8-201"><a href="#cb8-201" aria-hidden="true" tabindex="-1"></a>ax2.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb8-202"><a href="#cb8-202" aria-hidden="true" tabindex="-1"></a>ax2.spines[<span class="st">'top'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb8-203"><a href="#cb8-203" aria-hidden="true" tabindex="-1"></a>ax2.spines[<span class="st">'right'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb8-204"><a href="#cb8-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-205"><a href="#cb8-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 3: Risk-return trade-off</span></span>
<span id="cb8-206"><a href="#cb8-206" aria-hidden="true" tabindex="-1"></a>sharpe_ratios <span class="op">=</span> efficient_frontier[<span class="st">'Sharpe_Ratio'</span>]</span>
<span id="cb8-207"><a href="#cb8-207" aria-hidden="true" tabindex="-1"></a>ax3.plot(efficient_frontier[<span class="st">'Volatility'</span>], sharpe_ratios, <span class="st">'g-'</span>, linewidth<span class="op">=</span><span class="dv">3</span>, alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb8-208"><a href="#cb8-208" aria-hidden="true" tabindex="-1"></a>ax3.axhline(y<span class="op">=</span>tangency_portfolio[<span class="st">'sharpe_ratio'</span>], color<span class="op">=</span><span class="st">'gold'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, </span>
<span id="cb8-209"><a href="#cb8-209" aria-hidden="true" tabindex="-1"></a>           linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Max Sharpe Ratio'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb8-210"><a href="#cb8-210" aria-hidden="true" tabindex="-1"></a>ax3.scatter(tangency_portfolio[<span class="st">'volatility'</span>], tangency_portfolio[<span class="st">'sharpe_ratio'</span>], </span>
<span id="cb8-211"><a href="#cb8-211" aria-hidden="true" tabindex="-1"></a>           color<span class="op">=</span><span class="st">'gold'</span>, s<span class="op">=</span><span class="dv">150</span>, marker<span class="op">=</span><span class="st">'*'</span>, zorder<span class="op">=</span><span class="dv">5</span>, edgecolors<span class="op">=</span><span class="st">'white'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb8-212"><a href="#cb8-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-213"><a href="#cb8-213" aria-hidden="true" tabindex="-1"></a>ax3.set_xlabel(<span class="st">'Volatility'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb8-214"><a href="#cb8-214" aria-hidden="true" tabindex="-1"></a>ax3.set_ylabel(<span class="st">'Sharpe Ratio'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb8-215"><a href="#cb8-215" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="st">'Sharpe Ratio along Efficient Frontier'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb8-216"><a href="#cb8-216" aria-hidden="true" tabindex="-1"></a>ax3.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb8-217"><a href="#cb8-217" aria-hidden="true" tabindex="-1"></a>ax3.spines[<span class="st">'top'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb8-218"><a href="#cb8-218" aria-hidden="true" tabindex="-1"></a>ax3.spines[<span class="st">'right'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb8-219"><a href="#cb8-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-220"><a href="#cb8-220" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 4: Portfolio composition pie chart</span></span>
<span id="cb8-221"><a href="#cb8-221" aria-hidden="true" tabindex="-1"></a>top_weights <span class="op">=</span> tangency_portfolio[<span class="st">'weights'</span>].<span class="bu">abs</span>().nlargest(<span class="dv">6</span>)</span>
<span id="cb8-222"><a href="#cb8-222" aria-hidden="true" tabindex="-1"></a>other_weight <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> top_weights.<span class="bu">sum</span>()</span>
<span id="cb8-223"><a href="#cb8-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-224"><a href="#cb8-224" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> other_weight <span class="op">&gt;</span> <span class="fl">0.01</span>:</span>
<span id="cb8-225"><a href="#cb8-225" aria-hidden="true" tabindex="-1"></a>    plot_weights <span class="op">=</span> top_weights.tolist() <span class="op">+</span> [other_weight]</span>
<span id="cb8-226"><a href="#cb8-226" aria-hidden="true" tabindex="-1"></a>    plot_labels <span class="op">=</span> top_weights.index.tolist() <span class="op">+</span> [<span class="st">'Others'</span>]</span>
<span id="cb8-227"><a href="#cb8-227" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb8-228"><a href="#cb8-228" aria-hidden="true" tabindex="-1"></a>    plot_weights <span class="op">=</span> top_weights.tolist()</span>
<span id="cb8-229"><a href="#cb8-229" aria-hidden="true" tabindex="-1"></a>    plot_labels <span class="op">=</span> top_weights.index.tolist()</span>
<span id="cb8-230"><a href="#cb8-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-231"><a href="#cb8-231" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> plt.cm.Set3(np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="bu">len</span>(plot_weights)))</span>
<span id="cb8-232"><a href="#cb8-232" aria-hidden="true" tabindex="-1"></a>wedges, texts, autotexts <span class="op">=</span> ax4.pie(plot_weights, labels<span class="op">=</span>plot_labels, autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>, </span>
<span id="cb8-233"><a href="#cb8-233" aria-hidden="true" tabindex="-1"></a>                                   colors<span class="op">=</span>colors, startangle<span class="op">=</span><span class="dv">90</span>, </span>
<span id="cb8-234"><a href="#cb8-234" aria-hidden="true" tabindex="-1"></a>                                   wedgeprops<span class="op">=</span><span class="bu">dict</span>(edgecolor<span class="op">=</span><span class="st">'white'</span>, linewidth<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb8-235"><a href="#cb8-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-236"><a href="#cb8-236" aria-hidden="true" tabindex="-1"></a>ax4.set_title(<span class="st">'Tangency Portfolio Composition'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb8-237"><a href="#cb8-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-238"><a href="#cb8-238" aria-hidden="true" tabindex="-1"></a><span class="co"># Style the text</span></span>
<span id="cb8-239"><a href="#cb8-239" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> autotext <span class="kw">in</span> autotexts:</span>
<span id="cb8-240"><a href="#cb8-240" aria-hidden="true" tabindex="-1"></a>    autotext.set_color(<span class="st">'black'</span>)</span>
<span id="cb8-241"><a href="#cb8-241" aria-hidden="true" tabindex="-1"></a>    autotext.set_fontweight(<span class="st">'bold'</span>)</span>
<span id="cb8-242"><a href="#cb8-242" aria-hidden="true" tabindex="-1"></a>    autotext.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb8-243"><a href="#cb8-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-244"><a href="#cb8-244" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb8-245"><a href="#cb8-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-246"><a href="#cb8-246" aria-hidden="true" tabindex="-1"></a><span class="co"># Print results</span></span>
<span id="cb8-247"><a href="#cb8-247" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb8-248"><a href="#cb8-248" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"MEAN-VARIANCE OPTIMIZATION RESULTS"</span>)</span>
<span id="cb8-249"><a href="#cb8-249" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb8-250"><a href="#cb8-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-251"><a href="#cb8-251" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Minimum Variance Portfolio:"</span>)</span>
<span id="cb8-252"><a href="#cb8-252" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expected Return: </span><span class="sc">{</span>min_var_portfolio[<span class="st">'expected_return'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-253"><a href="#cb8-253" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Volatility: </span><span class="sc">{</span>min_var_portfolio[<span class="st">'volatility'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-254"><a href="#cb8-254" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sharpe Ratio: </span><span class="sc">{</span>min_var_portfolio[<span class="st">'sharpe_ratio'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-255"><a href="#cb8-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-256"><a href="#cb8-256" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Tangency Portfolio (Maximum Sharpe Ratio):"</span>)</span>
<span id="cb8-257"><a href="#cb8-257" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expected Return: </span><span class="sc">{</span>tangency_portfolio[<span class="st">'expected_return'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-258"><a href="#cb8-258" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Volatility: </span><span class="sc">{</span>tangency_portfolio[<span class="st">'volatility'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-259"><a href="#cb8-259" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sharpe Ratio: </span><span class="sc">{</span>tangency_portfolio[<span class="st">'sharpe_ratio'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-260"><a href="#cb8-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-261"><a href="#cb8-261" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top 5 holdings in Tangency Portfolio:"</span>)</span>
<span id="cb8-262"><a href="#cb8-262" aria-hidden="true" tabindex="-1"></a>top_holdings <span class="op">=</span> tangency_portfolio[<span class="st">'weights'</span>].<span class="bu">abs</span>().nlargest(<span class="dv">5</span>)</span>
<span id="cb8-263"><a href="#cb8-263" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> asset, weight <span class="kw">in</span> top_holdings.items():</span>
<span id="cb8-264"><a href="#cb8-264" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>asset<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>weight<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>weight<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-markowitz-optimization" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-markowitz-optimization-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-markowitz-optimization-output-1.png" width="1504" height="1046" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-markowitz-optimization-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Mean-variance efficient frontier and optimal portfolios
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
============================================================
MEAN-VARIANCE OPTIMIZATION RESULTS
============================================================

Minimum Variance Portfolio:
Expected Return: 0.1457
Volatility: 0.2752
Sharpe Ratio: 0.4569

Tangency Portfolio (Maximum Sharpe Ratio):
Expected Return: 1.8481
Volatility: 1.0493
Sharpe Ratio: 1.7422

Top 5 holdings in Tangency Portfolio:
NVDA: 2.5710 (257.1%)
AMD: 1.0341 (103.4%)
CRM: 0.8835 (88.3%)
AMZN: 0.5374 (53.7%)
TSLA: 0.5099 (51.0%)</code></pre>
</div>
</div>
</section>
<section id="sec-cvar-implementation" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="sec-cvar-implementation"><span class="header-section-number">6</span> Expected Shortfall (CVaR) Optimization</h2>
<p>Expected Shortfall optimization addresses the limitations of mean-variance optimization by focusing on tail risk. We implement both historical simulation and parametric approaches.</p>
<div id="cell-fig-cvar-optimization" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CVaROptimizer:</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Expected Shortfall (CVaR) portfolio optimizer using convex optimization.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, returns_data, alpha<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Initialize CVaR optimizer.</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">        returns_data : pandas.DataFrame</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">            Historical returns data</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">        alpha : float</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">            Confidence level for CVaR calculation (default 5%)</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.returns <span class="op">=</span> returns_data</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.alpha <span class="op">=</span> alpha</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_assets <span class="op">=</span> <span class="bu">len</span>(returns_data.columns)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_scenarios <span class="op">=</span> <span class="bu">len</span>(returns_data)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calculate_portfolio_cvar(<span class="va">self</span>, weights, returns_data<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co">        Calculate portfolio CVaR for given weights.</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="co">        weights : array-like</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="co">            Portfolio weights</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="co">        returns_data : pandas.DataFrame, optional</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="co">            Returns data (uses self.returns if not provided)</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="co">        --------</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="co">        tuple: (CVaR, VaR, expected_return, volatility)</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> returns_data <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>            returns_data <span class="op">=</span> <span class="va">self</span>.returns</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate portfolio returns</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>        portfolio_returns <span class="op">=</span> (returns_data <span class="op">*</span> weights).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate VaR</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        var <span class="op">=</span> np.percentile(portfolio_returns, <span class="va">self</span>.alpha <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate CVaR (Expected Shortfall)</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        cvar <span class="op">=</span> portfolio_returns[portfolio_returns <span class="op">&lt;=</span> var].mean()</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate expected return and volatility</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        expected_return <span class="op">=</span> portfolio_returns.mean() <span class="op">*</span> <span class="dv">252</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>        volatility <span class="op">=</span> portfolio_returns.std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>cvar <span class="op">*</span> np.sqrt(<span class="dv">252</span>), <span class="op">-</span>var <span class="op">*</span> np.sqrt(<span class="dv">252</span>), expected_return, volatility</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> optimize_cvar(<span class="va">self</span>, target_return<span class="op">=</span><span class="va">None</span>, max_weight<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a><span class="co">        Optimize portfolio to minimize CVaR.</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a><span class="co">        target_return : float, optional</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a><span class="co">            Target expected return constraint</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="co">        max_weight : float</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a><span class="co">            Maximum weight per asset</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a><span class="co">        --------</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Optimal weights and portfolio metrics</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Decision variables</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> cp.Variable(<span class="va">self</span>.n_assets)  <span class="co"># Portfolio weights</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>        zeta <span class="op">=</span> cp.Variable()            <span class="co"># VaR</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>        u <span class="op">=</span> cp.Variable(<span class="va">self</span>.n_scenarios)  <span class="co"># Auxiliary variables for CVaR</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Portfolio returns for each scenario</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>        portfolio_returns <span class="op">=</span> <span class="va">self</span>.returns.values <span class="op">@</span> w</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Objective: minimize CVaR</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>        objective <span class="op">=</span> cp.Minimize(zeta <span class="op">+</span> (<span class="dv">1</span> <span class="op">/</span> (<span class="va">self</span>.alpha <span class="op">*</span> <span class="va">self</span>.n_scenarios)) <span class="op">*</span> cp.<span class="bu">sum</span>(u))</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Constraints</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>        constraints <span class="op">=</span> [</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>            <span class="co"># CVaR constraints</span></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span>portfolio_returns <span class="op">-</span> zeta <span class="op">&lt;=</span> u,</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>            u <span class="op">&gt;=</span> <span class="dv">0</span>,</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Portfolio constraints</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>            cp.<span class="bu">sum</span>(w) <span class="op">==</span> <span class="dv">1</span>,</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>            w <span class="op">&gt;=</span> <span class="dv">0</span>,</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>            w <span class="op">&lt;=</span> max_weight</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add return constraint if specified</span></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> target_return <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>            expected_portfolio_return <span class="op">=</span> (<span class="va">self</span>.returns.mean().values <span class="op">@</span> w) <span class="op">*</span> <span class="dv">252</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>            constraints.append(expected_portfolio_return <span class="op">&gt;=</span> target_return)</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Solve optimization problem</span></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>        problem <span class="op">=</span> cp.Problem(objective, constraints)</span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>        problem.solve(solver<span class="op">=</span>cp.CLARABEL, verbose<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> problem.status <span class="op">!=</span> cp.OPTIMAL:</span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Optimization failed with status: </span><span class="sc">{</span>problem<span class="sc">.</span>status<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract results</span></span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>        optimal_weights <span class="op">=</span> w.value</span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>        cvar, var, expected_return, volatility <span class="op">=</span> <span class="va">self</span>.calculate_portfolio_cvar(optimal_weights)</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>            <span class="st">'weights'</span>: pd.Series(optimal_weights, index<span class="op">=</span><span class="va">self</span>.returns.columns),</span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cvar'</span>: cvar,</span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>            <span class="st">'var'</span>: var,</span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>            <span class="st">'expected_return'</span>: expected_return,</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>            <span class="st">'volatility'</span>: volatility,</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>            <span class="st">'sharpe_ratio'</span>: (expected_return <span class="op">-</span> <span class="fl">0.02</span>) <span class="op">/</span> volatility</span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> cvar_efficient_frontier(<span class="va">self</span>, n_points<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a><span class="co">        Generate CVaR efficient frontier.</span></span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a><span class="co">        n_points : int</span></span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a><span class="co">            Number of points on the frontier</span></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a><span class="co">        --------</span></span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a><span class="co">        pandas.DataFrame: CVaR efficient frontier</span></span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate return range</span></span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>        min_ret <span class="op">=</span> (<span class="va">self</span>.returns.mean() <span class="op">*</span> <span class="dv">252</span>).<span class="bu">min</span>()</span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>        max_ret <span class="op">=</span> (<span class="va">self</span>.returns.mean() <span class="op">*</span> <span class="dv">252</span>).<span class="bu">max</span>()</span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>        target_returns <span class="op">=</span> np.linspace(min_ret <span class="op">*</span> <span class="fl">0.5</span>, max_ret <span class="op">*</span> <span class="fl">0.9</span>, n_points)</span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>        efficient_portfolios <span class="op">=</span> []</span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> target_ret <span class="kw">in</span> target_returns:</span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>                portfolio <span class="op">=</span> <span class="va">self</span>.optimize_cvar(target_return<span class="op">=</span>target_ret)</span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a>                efficient_portfolios.append({</span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Expected_Return'</span>: portfolio[<span class="st">'expected_return'</span>],</span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'CVaR'</span>: portfolio[<span class="st">'cvar'</span>],</span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'VaR'</span>: portfolio[<span class="st">'var'</span>],</span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Volatility'</span>: portfolio[<span class="st">'volatility'</span>],</span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Sharpe_Ratio'</span>: portfolio[<span class="st">'sharpe_ratio'</span>]</span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame(efficient_portfolios)</span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize CVaR optimizer</span></span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>cvar_optimizer <span class="op">=</span> CVaROptimizer(returns, alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimize for minimum CVaR</span></span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a>min_cvar_portfolio <span class="op">=</span> cvar_optimizer.optimize_cvar()</span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate CVaR efficient frontier</span></span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a>cvar_frontier <span class="op">=</span> cvar_optimizer.cvar_efficient_frontier()</span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a><span class="co"># Create comprehensive visualization</span></span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Compare efficient frontiers (Mean-Variance vs CVaR)</span></span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].plot(efficient_frontier[<span class="st">'Volatility'</span>], efficient_frontier[<span class="st">'Expected_Return'</span>], </span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a>               <span class="st">'b-'</span>, linewidth<span class="op">=</span><span class="dv">3</span>, label<span class="op">=</span><span class="st">'Mean-Variance Frontier'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].plot(cvar_frontier[<span class="st">'Volatility'</span>], cvar_frontier[<span class="st">'Expected_Return'</span>], </span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a>               <span class="st">'r-'</span>, linewidth<span class="op">=</span><span class="dv">3</span>, label<span class="op">=</span><span class="st">'CVaR Frontier'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a><span class="co"># Add optimal portfolios</span></span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].scatter(tangency_portfolio[<span class="st">'volatility'</span>], tangency_portfolio[<span class="st">'expected_return'</span>], </span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a>                  color<span class="op">=</span><span class="st">'gold'</span>, s<span class="op">=</span><span class="dv">200</span>, marker<span class="op">=</span><span class="st">'*'</span>, label<span class="op">=</span><span class="st">'MV Tangency'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].scatter(min_cvar_portfolio[<span class="st">'volatility'</span>], min_cvar_portfolio[<span class="st">'expected_return'</span>], </span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a>                  color<span class="op">=</span><span class="st">'red'</span>, s<span class="op">=</span><span class="dv">200</span>, marker<span class="op">=</span><span class="st">'s'</span>, label<span class="op">=</span><span class="st">'Min CVaR'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Volatility (Annualized)'</span>)</span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Expected Return (Annualized)'</span>)</span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Efficient Frontiers: Mean-Variance vs CVaR'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].legend()</span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: CVaR vs Volatility trade-off</span></span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].scatter(cvar_frontier[<span class="st">'Volatility'</span>], cvar_frontier[<span class="st">'CVaR'</span>], </span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a>                  c<span class="op">=</span>cvar_frontier[<span class="st">'Expected_Return'</span>], cmap<span class="op">=</span><span class="st">'viridis'</span>, s<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].scatter(min_cvar_portfolio[<span class="st">'volatility'</span>], min_cvar_portfolio[<span class="st">'cvar'</span>], </span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a>                  color<span class="op">=</span><span class="st">'red'</span>, s<span class="op">=</span><span class="dv">200</span>, marker<span class="op">=</span><span class="st">'s'</span>, label<span class="op">=</span><span class="st">'Min CVaR'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Add colorbar</span></span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> plt.colorbar(plt.cm.ScalarMappable(cmap<span class="op">=</span><span class="st">'viridis'</span>), ax<span class="op">=</span>axes[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a>cbar.set_label(<span class="st">'Expected Return'</span>, rotation<span class="op">=</span><span class="dv">270</span>, labelpad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Volatility'</span>)</span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'CVaR (95% Confidence)'</span>)</span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'CVaR vs Volatility Trade-off'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].legend()</span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 3: Portfolio weights comparison</span></span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a>comparison_weights <span class="op">=</span> pd.DataFrame({</span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Mean-Variance'</span>: tangency_portfolio[<span class="st">'weights'</span>],</span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CVaR Optimal'</span>: min_cvar_portfolio[<span class="st">'weights'</span>]</span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(tickers))</span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-207"><a href="#cb10-207" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].bar(x <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>, comparison_weights[<span class="st">'Mean-Variance'</span>], width, </span>
<span id="cb10-208"><a href="#cb10-208" aria-hidden="true" tabindex="-1"></a>              label<span class="op">=</span><span class="st">'Mean-Variance'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, color<span class="op">=</span><span class="st">'gold'</span>)</span>
<span id="cb10-209"><a href="#cb10-209" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].bar(x <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span>, comparison_weights[<span class="st">'CVaR Optimal'</span>], width, </span>
<span id="cb10-210"><a href="#cb10-210" aria-hidden="true" tabindex="-1"></a>              label<span class="op">=</span><span class="st">'CVaR Optimal'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb10-211"><a href="#cb10-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-212"><a href="#cb10-212" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Assets'</span>)</span>
<span id="cb10-213"><a href="#cb10-213" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Portfolio Weight'</span>)</span>
<span id="cb10-214"><a href="#cb10-214" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Portfolio Weights: Mean-Variance vs CVaR'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb10-215"><a href="#cb10-215" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_xticks(x)</span>
<span id="cb10-216"><a href="#cb10-216" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_xticklabels(tickers, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb10-217"><a href="#cb10-217" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].legend()</span>
<span id="cb10-218"><a href="#cb10-218" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb10-219"><a href="#cb10-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-220"><a href="#cb10-220" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 4: Risk measures comparison</span></span>
<span id="cb10-221"><a href="#cb10-221" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns for both strategies</span></span>
<span id="cb10-222"><a href="#cb10-222" aria-hidden="true" tabindex="-1"></a>mv_portfolio_returns <span class="op">=</span> (returns <span class="op">*</span> tangency_portfolio[<span class="st">'weights'</span>]).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-223"><a href="#cb10-223" aria-hidden="true" tabindex="-1"></a>cvar_portfolio_returns <span class="op">=</span> (returns <span class="op">*</span> min_cvar_portfolio[<span class="st">'weights'</span>]).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-224"><a href="#cb10-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-225"><a href="#cb10-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate various risk measures</span></span>
<span id="cb10-226"><a href="#cb10-226" aria-hidden="true" tabindex="-1"></a>risk_measures <span class="op">=</span> pd.DataFrame({</span>
<span id="cb10-227"><a href="#cb10-227" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Mean-Variance'</span>: [</span>
<span id="cb10-228"><a href="#cb10-228" aria-hidden="true" tabindex="-1"></a>        mv_portfolio_returns.std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>),  <span class="co"># Volatility</span></span>
<span id="cb10-229"><a href="#cb10-229" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span>np.percentile(mv_portfolio_returns, <span class="dv">5</span>) <span class="op">*</span> np.sqrt(<span class="dv">252</span>),  <span class="co"># VaR</span></span>
<span id="cb10-230"><a href="#cb10-230" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span>mv_portfolio_returns[mv_portfolio_returns <span class="op">&lt;=</span> np.percentile(mv_portfolio_returns, <span class="dv">5</span>)].mean() <span class="op">*</span> np.sqrt(<span class="dv">252</span>),  <span class="co"># CVaR</span></span>
<span id="cb10-231"><a href="#cb10-231" aria-hidden="true" tabindex="-1"></a>        mv_portfolio_returns.<span class="bu">min</span>() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)  <span class="co"># Maximum Loss</span></span>
<span id="cb10-232"><a href="#cb10-232" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb10-233"><a href="#cb10-233" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CVaR Optimal'</span>: [</span>
<span id="cb10-234"><a href="#cb10-234" aria-hidden="true" tabindex="-1"></a>        cvar_portfolio_returns.std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>),  <span class="co"># Volatility</span></span>
<span id="cb10-235"><a href="#cb10-235" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span>np.percentile(cvar_portfolio_returns, <span class="dv">5</span>) <span class="op">*</span> np.sqrt(<span class="dv">252</span>),  <span class="co"># VaR</span></span>
<span id="cb10-236"><a href="#cb10-236" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span>cvar_portfolio_returns[cvar_portfolio_returns <span class="op">&lt;=</span> np.percentile(cvar_portfolio_returns, <span class="dv">5</span>)].mean() <span class="op">*</span> np.sqrt(<span class="dv">252</span>),  <span class="co"># CVaR</span></span>
<span id="cb10-237"><a href="#cb10-237" aria-hidden="true" tabindex="-1"></a>        cvar_portfolio_returns.<span class="bu">min</span>() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)  <span class="co"># Maximum Loss</span></span>
<span id="cb10-238"><a href="#cb10-238" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb10-239"><a href="#cb10-239" aria-hidden="true" tabindex="-1"></a>}, index<span class="op">=</span>[<span class="st">'Volatility'</span>, <span class="st">'VaR (95%)'</span>, <span class="st">'CVaR (95%)'</span>, <span class="st">'Max Loss'</span>])</span>
<span id="cb10-240"><a href="#cb10-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-241"><a href="#cb10-241" aria-hidden="true" tabindex="-1"></a><span class="co"># Create heatmap</span></span>
<span id="cb10-242"><a href="#cb10-242" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>].imshow(risk_measures.values, cmap<span class="op">=</span><span class="st">'Reds'</span>, aspect<span class="op">=</span><span class="st">'auto'</span>)</span>
<span id="cb10-243"><a href="#cb10-243" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Risk Measures Comparison'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb10-244"><a href="#cb10-244" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(risk_measures.columns)))</span>
<span id="cb10-245"><a href="#cb10-245" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(risk_measures.index)))</span>
<span id="cb10-246"><a href="#cb10-246" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_xticklabels(risk_measures.columns)</span>
<span id="cb10-247"><a href="#cb10-247" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_yticklabels(risk_measures.index)</span>
<span id="cb10-248"><a href="#cb10-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-249"><a href="#cb10-249" aria-hidden="true" tabindex="-1"></a><span class="co"># Add values to heatmap</span></span>
<span id="cb10-250"><a href="#cb10-250" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(risk_measures.index)):</span>
<span id="cb10-251"><a href="#cb10-251" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(risk_measures.columns)):</span>
<span id="cb10-252"><a href="#cb10-252" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].text(j, i, <span class="ss">f'</span><span class="sc">{</span>risk_measures<span class="sc">.</span>iloc[i, j]<span class="sc">:.3f}</span><span class="ss">'</span>, </span>
<span id="cb10-253"><a href="#cb10-253" aria-hidden="true" tabindex="-1"></a>                       ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb10-254"><a href="#cb10-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-255"><a href="#cb10-255" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb10-256"><a href="#cb10-256" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb10-257"><a href="#cb10-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-258"><a href="#cb10-258" aria-hidden="true" tabindex="-1"></a><span class="co"># Print detailed results</span></span>
<span id="cb10-259"><a href="#cb10-259" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb10-260"><a href="#cb10-260" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CVaR OPTIMIZATION RESULTS"</span>)</span>
<span id="cb10-261"><a href="#cb10-261" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb10-262"><a href="#cb10-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-263"><a href="#cb10-263" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Minimum CVaR Portfolio:"</span>)</span>
<span id="cb10-264"><a href="#cb10-264" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expected Return: </span><span class="sc">{</span>min_cvar_portfolio[<span class="st">'expected_return'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb10-265"><a href="#cb10-265" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Volatility: </span><span class="sc">{</span>min_cvar_portfolio[<span class="st">'volatility'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb10-266"><a href="#cb10-266" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CVaR (95%): </span><span class="sc">{</span>min_cvar_portfolio[<span class="st">'cvar'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb10-267"><a href="#cb10-267" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"VaR (95%): </span><span class="sc">{</span>min_cvar_portfolio[<span class="st">'var'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb10-268"><a href="#cb10-268" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sharpe Ratio: </span><span class="sc">{</span>min_cvar_portfolio[<span class="st">'sharpe_ratio'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb10-269"><a href="#cb10-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-270"><a href="#cb10-270" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Comparison with Mean-Variance Tangency Portfolio:"</span>)</span>
<span id="cb10-271"><a href="#cb10-271" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Metric'</span><span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Mean-Variance'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'CVaR Optimal'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Difference'</span><span class="sc">:&lt;15}</span><span class="ss">"</span>)</span>
<span id="cb10-272"><a href="#cb10-272" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">65</span>)</span>
<span id="cb10-273"><a href="#cb10-273" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Expected Return'</span><span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span>tangency_portfolio[<span class="st">'expected_return'</span>]<span class="sc">:&lt;15.4f}</span><span class="ss"> </span><span class="sc">{</span>min_cvar_portfolio[<span class="st">'expected_return'</span>]<span class="sc">:&lt;15.4f}</span><span class="ss"> </span><span class="sc">{</span>min_cvar_portfolio[<span class="st">'expected_return'</span>] <span class="op">-</span> tangency_portfolio[<span class="st">'expected_return'</span>]<span class="sc">:&lt;15.4f}</span><span class="ss">"</span>)</span>
<span id="cb10-274"><a href="#cb10-274" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Volatility'</span><span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span>tangency_portfolio[<span class="st">'volatility'</span>]<span class="sc">:&lt;15.4f}</span><span class="ss"> </span><span class="sc">{</span>min_cvar_portfolio[<span class="st">'volatility'</span>]<span class="sc">:&lt;15.4f}</span><span class="ss"> </span><span class="sc">{</span>min_cvar_portfolio[<span class="st">'volatility'</span>] <span class="op">-</span> tangency_portfolio[<span class="st">'volatility'</span>]<span class="sc">:&lt;15.4f}</span><span class="ss">"</span>)</span>
<span id="cb10-275"><a href="#cb10-275" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Sharpe Ratio'</span><span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span>tangency_portfolio[<span class="st">'sharpe_ratio'</span>]<span class="sc">:&lt;15.4f}</span><span class="ss"> </span><span class="sc">{</span>min_cvar_portfolio[<span class="st">'sharpe_ratio'</span>]<span class="sc">:&lt;15.4f}</span><span class="ss"> </span><span class="sc">{</span>min_cvar_portfolio[<span class="st">'sharpe_ratio'</span>] <span class="op">-</span> tangency_portfolio[<span class="st">'sharpe_ratio'</span>]<span class="sc">:&lt;15.4f}</span><span class="ss">"</span>)</span>
<span id="cb10-276"><a href="#cb10-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-277"><a href="#cb10-277" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top 5 holdings in CVaR Optimal Portfolio:"</span>)</span>
<span id="cb10-278"><a href="#cb10-278" aria-hidden="true" tabindex="-1"></a>top_cvar_holdings <span class="op">=</span> min_cvar_portfolio[<span class="st">'weights'</span>].<span class="bu">abs</span>().nlargest(<span class="dv">5</span>)</span>
<span id="cb10-279"><a href="#cb10-279" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> asset, weight <span class="kw">in</span> top_cvar_holdings.items():</span>
<span id="cb10-280"><a href="#cb10-280" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>asset<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>weight<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>weight<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-cvar-optimization" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cvar-optimization-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-cvar-optimization-output-1.png" width="2675" height="1776" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cvar-optimization-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Expected Shortfall optimization and comparison with mean-variance
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
============================================================
CVaR OPTIMIZATION RESULTS
============================================================

Minimum CVaR Portfolio:
Expected Return: 0.2790
Volatility: 0.2902
CVaR (95%): 0.6523
VaR (95%): 0.4414
Sharpe Ratio: 0.8924

Comparison with Mean-Variance Tangency Portfolio:
Metric               Mean-Variance   CVaR Optimal    Difference     
-----------------------------------------------------------------
Expected Return      1.8481          0.2790          -1.5691        
Volatility           1.0493          0.2902          -0.7590        
Sharpe Ratio         1.7422          0.8924          -0.8498        

Top 5 holdings in CVaR Optimal Portfolio:
MSFT: 0.4168 (41.7%)
AAPL: 0.2774 (27.7%)
GOOGL: 0.1767 (17.7%)
AMZN: 0.0977 (9.8%)
NFLX: 0.0314 (3.1%)</code></pre>
</div>
</div>
</section>
<section id="sec-ga-implementation" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="sec-ga-implementation"><span class="header-section-number">7</span> Genetic Algorithm Optimization</h2>
<p>Genetic algorithms provide a powerful metaheuristic approach for portfolio optimization, particularly when dealing with complex constraints or non-convex objectives. We implement a custom genetic algorithm specifically designed for portfolio optimization.</p>
<div id="cell-fig-genetic-algorithm" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> deap <span class="im">import</span> base, creator, tools, algorithms</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GeneticPortfolioOptimizer:</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Genetic Algorithm for portfolio optimization with custom operators.</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, returns_data, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>):</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Initialize genetic algorithm optimizer.</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">        returns_data : pandas.DataFrame</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">            Historical returns data</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co">        risk_free_rate : float</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co">            Risk-free rate for Sharpe ratio calculation</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.returns <span class="op">=</span> returns_data</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mean_returns <span class="op">=</span> returns_data.mean() <span class="op">*</span> <span class="dv">252</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cov_matrix <span class="op">=</span> returns_data.cov() <span class="op">*</span> <span class="dv">252</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_free_rate <span class="op">=</span> risk_free_rate</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_assets <span class="op">=</span> <span class="bu">len</span>(returns_data.columns)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Setup DEAP framework</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._setup_deap()</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _setup_deap(<span class="va">self</span>):</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Setup DEAP genetic algorithm framework."""</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create fitness and individual classes</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>        creator.create(<span class="st">"FitnessMax"</span>, base.Fitness, weights<span class="op">=</span>(<span class="fl">1.0</span>,))</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>        creator.create(<span class="st">"Individual"</span>, <span class="bu">list</span>, fitness<span class="op">=</span>creator.FitnessMax)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize toolbox</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.toolbox <span class="op">=</span> base.Toolbox()</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Attribute generator: random weights</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.toolbox.register(<span class="st">"attr_weight"</span>, random.uniform, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Structure initializers</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.toolbox.register(<span class="st">"individual"</span>, tools.initRepeat, creator.Individual,</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>                             <span class="va">self</span>.toolbox.attr_weight, n<span class="op">=</span><span class="va">self</span>.n_assets)</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.toolbox.register(<span class="st">"population"</span>, tools.initRepeat, <span class="bu">list</span>, <span class="va">self</span>.toolbox.individual)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Register genetic operators</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.toolbox.register(<span class="st">"evaluate"</span>, <span class="va">self</span>._evaluate_individual)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.toolbox.register(<span class="st">"mate"</span>, <span class="va">self</span>._crossover)</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.toolbox.register(<span class="st">"mutate"</span>, <span class="va">self</span>._mutate)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.toolbox.register(<span class="st">"select"</span>, tools.selTournament, tournsize<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _normalize_weights(<span class="va">self</span>, individual):</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Normalize weights to sum to 1."""</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="bu">sum</span>(individual)</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [<span class="fl">1.0</span><span class="op">/</span><span class="va">self</span>.n_assets] <span class="op">*</span> <span class="va">self</span>.n_assets</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [w<span class="op">/</span>total <span class="cf">for</span> w <span class="kw">in</span> individual]</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _evaluate_individual(<span class="va">self</span>, individual):</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a><span class="co">        Evaluate fitness of an individual (portfolio).</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a><span class="co">        individual : list</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a><span class="co">            Portfolio weights</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a><span class="co">        --------</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a><span class="co">        tuple: Fitness value (Sharpe ratio)</span></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize weights</span></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> <span class="va">self</span>._normalize_weights(individual)</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> np.array(weights)</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate portfolio metrics</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>        portfolio_return <span class="op">=</span> np.<span class="bu">sum</span>(weights <span class="op">*</span> <span class="va">self</span>.mean_returns)</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>        portfolio_variance <span class="op">=</span> np.dot(weights.T, np.dot(<span class="va">self</span>.cov_matrix, weights))</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>        portfolio_std <span class="op">=</span> np.sqrt(portfolio_variance)</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle edge cases</span></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> portfolio_std <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (<span class="op">-</span><span class="fl">1000.0</span>,)</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate Sharpe ratio</span></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>        sharpe_ratio <span class="op">=</span> (portfolio_return <span class="op">-</span> <span class="va">self</span>.risk_free_rate) <span class="op">/</span> portfolio_std</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (sharpe_ratio,)</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _crossover(<span class="va">self</span>, ind1, ind2):</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a><span class="co">        Custom crossover operator using blend crossover (BLX-α).</span></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a><span class="co">        ind1, ind2 : list</span></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a><span class="co">            Parent individuals</span></span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a><span class="co">        --------</span></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a><span class="co">        tuple: Modified parent individuals</span></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(ind1)):</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate range</span></span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>            min_val <span class="op">=</span> <span class="bu">min</span>(ind1[i], ind2[i])</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>            max_val <span class="op">=</span> <span class="bu">max</span>(ind1[i], ind2[i])</span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a>            range_val <span class="op">=</span> max_val <span class="op">-</span> min_val</span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Generate new values</span></span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>            low <span class="op">=</span> min_val <span class="op">-</span> alpha <span class="op">*</span> range_val</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>            high <span class="op">=</span> max_val <span class="op">+</span> alpha <span class="op">*</span> range_val</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Ensure non-negative weights</span></span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a>            low <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, low)</span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a>            high <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, high)</span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create offspring</span></span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a>            ind1[i] <span class="op">=</span> random.uniform(low, high)</span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>            ind2[i] <span class="op">=</span> random.uniform(low, high)</span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ind1, ind2</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _mutate(<span class="va">self</span>, individual):</span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a><span class="co">        Custom mutation operator using Gaussian mutation.</span></span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a><span class="co">        individual : list</span></span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a><span class="co">            Individual to mutate</span></span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a><span class="co">        --------</span></span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a><span class="co">        tuple: Mutated individual</span></span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a>        mutation_strength <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(individual)):</span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> random.random() <span class="op">&lt;</span> <span class="fl">0.2</span>:  <span class="co"># Mutation probability</span></span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a>                individual[i] <span class="op">+=</span> random.gauss(<span class="dv">0</span>, mutation_strength)</span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>                individual[i] <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, individual[i])  <span class="co"># Ensure non-negative</span></span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (individual,)</span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> optimize(<span class="va">self</span>, population_size<span class="op">=</span><span class="dv">100</span>, generations<span class="op">=</span><span class="dv">50</span>, cx_prob<span class="op">=</span><span class="fl">0.7</span>, mut_prob<span class="op">=</span><span class="fl">0.2</span>):</span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a><span class="co">        Run genetic algorithm optimization.</span></span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a><span class="co">        -----------</span></span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a><span class="co">        population_size : int</span></span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a><span class="co">            Size of population</span></span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a><span class="co">        generations : int</span></span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a><span class="co">            Number of generations</span></span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a><span class="co">        cx_prob : float</span></span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a><span class="co">            Crossover probability</span></span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a><span class="co">        mut_prob : float</span></span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a><span class="co">            Mutation probability</span></span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a><span class="co">        --------</span></span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Best individual and optimization statistics</span></span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize population</span></span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a>        population <span class="op">=</span> <span class="va">self</span>.toolbox.population(n<span class="op">=</span>population_size)</span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Statistics tracking</span></span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a>        stats <span class="op">=</span> tools.Statistics(<span class="kw">lambda</span> ind: ind.fitness.values)</span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a>        stats.register(<span class="st">"avg"</span>, np.mean)</span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a>        stats.register(<span class="st">"min"</span>, np.<span class="bu">min</span>)</span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a>        stats.register(<span class="st">"max"</span>, np.<span class="bu">max</span>)</span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a>        stats.register(<span class="st">"std"</span>, np.std)</span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Hall of fame to track best individuals</span></span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a>        hof <span class="op">=</span> tools.HallOfFame(<span class="dv">1</span>)</span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Evolution tracking</span></span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fitness_evolution <span class="op">=</span> []</span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run algorithm</span></span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> gen <span class="kw">in</span> <span class="bu">range</span>(generations):</span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Evaluate population</span></span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a>            fitnesses <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="va">self</span>.toolbox.evaluate, population))</span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> ind, fit <span class="kw">in</span> <span class="bu">zip</span>(population, fitnesses):</span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a>                ind.fitness.values <span class="op">=</span> fit</span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update hall of fame</span></span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a>            hof.update(population)</span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Record statistics</span></span>
<span id="cb12-191"><a href="#cb12-191" aria-hidden="true" tabindex="-1"></a>            record <span class="op">=</span> stats.<span class="bu">compile</span>(population)</span>
<span id="cb12-192"><a href="#cb12-192" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.fitness_evolution.append(record)</span>
<span id="cb12-193"><a href="#cb12-193" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-194"><a href="#cb12-194" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> gen <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb12-195"><a href="#cb12-195" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Generation </span><span class="sc">{</span>gen<span class="sc">}</span><span class="ss">: Max Fitness = </span><span class="sc">{</span>record[<span class="st">'max'</span>]<span class="sc">:.4f}</span><span class="ss">, Avg Fitness = </span><span class="sc">{</span>record[<span class="st">'avg'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb12-196"><a href="#cb12-196" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-197"><a href="#cb12-197" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Selection</span></span>
<span id="cb12-198"><a href="#cb12-198" aria-hidden="true" tabindex="-1"></a>            offspring <span class="op">=</span> <span class="va">self</span>.toolbox.select(population, <span class="bu">len</span>(population))</span>
<span id="cb12-199"><a href="#cb12-199" aria-hidden="true" tabindex="-1"></a>            offspring <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="va">self</span>.toolbox.clone, offspring))</span>
<span id="cb12-200"><a href="#cb12-200" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-201"><a href="#cb12-201" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Crossover and mutation</span></span>
<span id="cb12-202"><a href="#cb12-202" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> child1, child2 <span class="kw">in</span> <span class="bu">zip</span>(offspring[::<span class="dv">2</span>], offspring[<span class="dv">1</span>::<span class="dv">2</span>]):</span>
<span id="cb12-203"><a href="#cb12-203" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> random.random() <span class="op">&lt;</span> cx_prob:</span>
<span id="cb12-204"><a href="#cb12-204" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.toolbox.mate(child1, child2)</span>
<span id="cb12-205"><a href="#cb12-205" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">del</span> child1.fitness.values</span>
<span id="cb12-206"><a href="#cb12-206" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">del</span> child2.fitness.values</span>
<span id="cb12-207"><a href="#cb12-207" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-208"><a href="#cb12-208" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> mutant <span class="kw">in</span> offspring:</span>
<span id="cb12-209"><a href="#cb12-209" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> random.random() <span class="op">&lt;</span> mut_prob:</span>
<span id="cb12-210"><a href="#cb12-210" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.toolbox.mutate(mutant)</span>
<span id="cb12-211"><a href="#cb12-211" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">del</span> mutant.fitness.values</span>
<span id="cb12-212"><a href="#cb12-212" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-213"><a href="#cb12-213" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Replace population</span></span>
<span id="cb12-214"><a href="#cb12-214" aria-hidden="true" tabindex="-1"></a>            population[:] <span class="op">=</span> offspring</span>
<span id="cb12-215"><a href="#cb12-215" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get best individual</span></span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a>        best_individual <span class="op">=</span> hof[<span class="dv">0</span>]</span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a>        best_weights <span class="op">=</span> <span class="va">self</span>._normalize_weights(best_individual)</span>
<span id="cb12-219"><a href="#cb12-219" aria-hidden="true" tabindex="-1"></a>        best_weights <span class="op">=</span> np.array(best_weights)</span>
<span id="cb12-220"><a href="#cb12-220" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-221"><a href="#cb12-221" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate final portfolio metrics</span></span>
<span id="cb12-222"><a href="#cb12-222" aria-hidden="true" tabindex="-1"></a>        portfolio_return <span class="op">=</span> np.<span class="bu">sum</span>(best_weights <span class="op">*</span> <span class="va">self</span>.mean_returns)</span>
<span id="cb12-223"><a href="#cb12-223" aria-hidden="true" tabindex="-1"></a>        portfolio_variance <span class="op">=</span> np.dot(best_weights.T, np.dot(<span class="va">self</span>.cov_matrix, best_weights))</span>
<span id="cb12-224"><a href="#cb12-224" aria-hidden="true" tabindex="-1"></a>        portfolio_std <span class="op">=</span> np.sqrt(portfolio_variance)</span>
<span id="cb12-225"><a href="#cb12-225" aria-hidden="true" tabindex="-1"></a>        sharpe_ratio <span class="op">=</span> (portfolio_return <span class="op">-</span> <span class="va">self</span>.risk_free_rate) <span class="op">/</span> portfolio_std</span>
<span id="cb12-226"><a href="#cb12-226" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-227"><a href="#cb12-227" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb12-228"><a href="#cb12-228" aria-hidden="true" tabindex="-1"></a>            <span class="st">'weights'</span>: pd.Series(best_weights, index<span class="op">=</span><span class="va">self</span>.returns.columns),</span>
<span id="cb12-229"><a href="#cb12-229" aria-hidden="true" tabindex="-1"></a>            <span class="st">'expected_return'</span>: portfolio_return,</span>
<span id="cb12-230"><a href="#cb12-230" aria-hidden="true" tabindex="-1"></a>            <span class="st">'volatility'</span>: portfolio_std,</span>
<span id="cb12-231"><a href="#cb12-231" aria-hidden="true" tabindex="-1"></a>            <span class="st">'sharpe_ratio'</span>: sharpe_ratio,</span>
<span id="cb12-232"><a href="#cb12-232" aria-hidden="true" tabindex="-1"></a>            <span class="st">'fitness_evolution'</span>: <span class="va">self</span>.fitness_evolution</span>
<span id="cb12-233"><a href="#cb12-233" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-234"><a href="#cb12-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-235"><a href="#cb12-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize genetic algorithm optimizer</span></span>
<span id="cb12-236"><a href="#cb12-236" aria-hidden="true" tabindex="-1"></a>ga_optimizer <span class="op">=</span> GeneticPortfolioOptimizer(returns)</span>
<span id="cb12-237"><a href="#cb12-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-238"><a href="#cb12-238" aria-hidden="true" tabindex="-1"></a><span class="co"># Run optimization</span></span>
<span id="cb12-239"><a href="#cb12-239" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Running Genetic Algorithm Optimization..."</span>)</span>
<span id="cb12-240"><a href="#cb12-240" aria-hidden="true" tabindex="-1"></a>ga_result <span class="op">=</span> ga_optimizer.optimize(population_size<span class="op">=</span><span class="dv">100</span>, generations<span class="op">=</span><span class="dv">100</span>, cx_prob<span class="op">=</span><span class="fl">0.7</span>, mut_prob<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb12-241"><a href="#cb12-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-242"><a href="#cb12-242" aria-hidden="true" tabindex="-1"></a><span class="co"># Create comprehensive visualization</span></span>
<span id="cb12-243"><a href="#cb12-243" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb12-244"><a href="#cb12-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-245"><a href="#cb12-245" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Convergence analysis</span></span>
<span id="cb12-246"><a href="#cb12-246" aria-hidden="true" tabindex="-1"></a>generations <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(ga_result[<span class="st">'fitness_evolution'</span>]))</span>
<span id="cb12-247"><a href="#cb12-247" aria-hidden="true" tabindex="-1"></a>max_fitness <span class="op">=</span> [gen[<span class="st">'max'</span>] <span class="cf">for</span> gen <span class="kw">in</span> ga_result[<span class="st">'fitness_evolution'</span>]]</span>
<span id="cb12-248"><a href="#cb12-248" aria-hidden="true" tabindex="-1"></a>avg_fitness <span class="op">=</span> [gen[<span class="st">'avg'</span>] <span class="cf">for</span> gen <span class="kw">in</span> ga_result[<span class="st">'fitness_evolution'</span>]]</span>
<span id="cb12-249"><a href="#cb12-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-250"><a href="#cb12-250" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].plot(generations, max_fitness, <span class="st">'r-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Best Fitness'</span>)</span>
<span id="cb12-251"><a href="#cb12-251" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].plot(generations, avg_fitness, <span class="st">'b-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Average Fitness'</span>)</span>
<span id="cb12-252"><a href="#cb12-252" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Generation'</span>)</span>
<span id="cb12-253"><a href="#cb12-253" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Fitness (Sharpe Ratio)'</span>)</span>
<span id="cb12-254"><a href="#cb12-254" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Genetic Algorithm Convergence'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb12-255"><a href="#cb12-255" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].legend()</span>
<span id="cb12-256"><a href="#cb12-256" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb12-257"><a href="#cb12-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-258"><a href="#cb12-258" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: Compare all three approaches</span></span>
<span id="cb12-259"><a href="#cb12-259" aria-hidden="true" tabindex="-1"></a>all_methods_weights <span class="op">=</span> pd.DataFrame({</span>
<span id="cb12-260"><a href="#cb12-260" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Mean-Variance'</span>: tangency_portfolio[<span class="st">'weights'</span>],</span>
<span id="cb12-261"><a href="#cb12-261" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CVaR Optimal'</span>: min_cvar_portfolio[<span class="st">'weights'</span>],</span>
<span id="cb12-262"><a href="#cb12-262" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Genetic Algorithm'</span>: ga_result[<span class="st">'weights'</span>]</span>
<span id="cb12-263"><a href="#cb12-263" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb12-264"><a href="#cb12-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-265"><a href="#cb12-265" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(tickers))</span>
<span id="cb12-266"><a href="#cb12-266" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb12-267"><a href="#cb12-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-268"><a href="#cb12-268" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].bar(x <span class="op">-</span> width, all_methods_weights[<span class="st">'Mean-Variance'</span>], width, </span>
<span id="cb12-269"><a href="#cb12-269" aria-hidden="true" tabindex="-1"></a>              label<span class="op">=</span><span class="st">'Mean-Variance'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, color<span class="op">=</span><span class="st">'gold'</span>)</span>
<span id="cb12-270"><a href="#cb12-270" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].bar(x, all_methods_weights[<span class="st">'CVaR Optimal'</span>], width, </span>
<span id="cb12-271"><a href="#cb12-271" aria-hidden="true" tabindex="-1"></a>              label<span class="op">=</span><span class="st">'CVaR Optimal'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb12-272"><a href="#cb12-272" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].bar(x <span class="op">+</span> width, all_methods_weights[<span class="st">'Genetic Algorithm'</span>], width, </span>
<span id="cb12-273"><a href="#cb12-273" aria-hidden="true" tabindex="-1"></a>              label<span class="op">=</span><span class="st">'Genetic Algorithm'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, color<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb12-274"><a href="#cb12-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-275"><a href="#cb12-275" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Assets'</span>)</span>
<span id="cb12-276"><a href="#cb12-276" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Portfolio Weight'</span>)</span>
<span id="cb12-277"><a href="#cb12-277" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Portfolio Weights: All Methods Comparison'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb12-278"><a href="#cb12-278" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].set_xticks(x)</span>
<span id="cb12-279"><a href="#cb12-279" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].set_xticklabels(tickers, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb12-280"><a href="#cb12-280" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].legend()</span>
<span id="cb12-281"><a href="#cb12-281" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb12-282"><a href="#cb12-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-283"><a href="#cb12-283" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 3: Risk-Return comparison</span></span>
<span id="cb12-284"><a href="#cb12-284" aria-hidden="true" tabindex="-1"></a>methods <span class="op">=</span> [<span class="st">'Mean-Variance'</span>, <span class="st">'CVaR Optimal'</span>, <span class="st">'Genetic Algorithm'</span>]</span>
<span id="cb12-285"><a href="#cb12-285" aria-hidden="true" tabindex="-1"></a>returns_list <span class="op">=</span> [tangency_portfolio[<span class="st">'expected_return'</span>], </span>
<span id="cb12-286"><a href="#cb12-286" aria-hidden="true" tabindex="-1"></a>                min_cvar_portfolio[<span class="st">'expected_return'</span>], </span>
<span id="cb12-287"><a href="#cb12-287" aria-hidden="true" tabindex="-1"></a>                ga_result[<span class="st">'expected_return'</span>]]</span>
<span id="cb12-288"><a href="#cb12-288" aria-hidden="true" tabindex="-1"></a>volatilities_list <span class="op">=</span> [tangency_portfolio[<span class="st">'volatility'</span>], </span>
<span id="cb12-289"><a href="#cb12-289" aria-hidden="true" tabindex="-1"></a>                     min_cvar_portfolio[<span class="st">'volatility'</span>], </span>
<span id="cb12-290"><a href="#cb12-290" aria-hidden="true" tabindex="-1"></a>                     ga_result[<span class="st">'volatility'</span>]]</span>
<span id="cb12-291"><a href="#cb12-291" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'gold'</span>, <span class="st">'red'</span>, <span class="st">'green'</span>]</span>
<span id="cb12-292"><a href="#cb12-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-293"><a href="#cb12-293" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (method, ret, vol, color) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(methods, returns_list, volatilities_list, colors)):</span>
<span id="cb12-294"><a href="#cb12-294" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>, <span class="dv">0</span>].scatter(vol, ret, s<span class="op">=</span><span class="dv">200</span>, c<span class="op">=</span>color, label<span class="op">=</span>method, alpha<span class="op">=</span><span class="fl">0.8</span>, edgecolors<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb12-295"><a href="#cb12-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-296"><a href="#cb12-296" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Volatility (Annualized)'</span>)</span>
<span id="cb12-297"><a href="#cb12-297" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Expected Return (Annualized)'</span>)</span>
<span id="cb12-298"><a href="#cb12-298" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Risk-Return Profile: All Methods'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb12-299"><a href="#cb12-299" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].legend()</span>
<span id="cb12-300"><a href="#cb12-300" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb12-301"><a href="#cb12-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-302"><a href="#cb12-302" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 4: Performance metrics comparison</span></span>
<span id="cb12-303"><a href="#cb12-303" aria-hidden="true" tabindex="-1"></a>performance_metrics <span class="op">=</span> pd.DataFrame({</span>
<span id="cb12-304"><a href="#cb12-304" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Mean-Variance'</span>: [</span>
<span id="cb12-305"><a href="#cb12-305" aria-hidden="true" tabindex="-1"></a>        tangency_portfolio[<span class="st">'expected_return'</span>],</span>
<span id="cb12-306"><a href="#cb12-306" aria-hidden="true" tabindex="-1"></a>        tangency_portfolio[<span class="st">'volatility'</span>],</span>
<span id="cb12-307"><a href="#cb12-307" aria-hidden="true" tabindex="-1"></a>        tangency_portfolio[<span class="st">'sharpe_ratio'</span>]</span>
<span id="cb12-308"><a href="#cb12-308" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb12-309"><a href="#cb12-309" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CVaR Optimal'</span>: [</span>
<span id="cb12-310"><a href="#cb12-310" aria-hidden="true" tabindex="-1"></a>        min_cvar_portfolio[<span class="st">'expected_return'</span>],</span>
<span id="cb12-311"><a href="#cb12-311" aria-hidden="true" tabindex="-1"></a>        min_cvar_portfolio[<span class="st">'volatility'</span>],</span>
<span id="cb12-312"><a href="#cb12-312" aria-hidden="true" tabindex="-1"></a>        min_cvar_portfolio[<span class="st">'sharpe_ratio'</span>]</span>
<span id="cb12-313"><a href="#cb12-313" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb12-314"><a href="#cb12-314" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Genetic Algorithm'</span>: [</span>
<span id="cb12-315"><a href="#cb12-315" aria-hidden="true" tabindex="-1"></a>        ga_result[<span class="st">'expected_return'</span>],</span>
<span id="cb12-316"><a href="#cb12-316" aria-hidden="true" tabindex="-1"></a>        ga_result[<span class="st">'volatility'</span>],</span>
<span id="cb12-317"><a href="#cb12-317" aria-hidden="true" tabindex="-1"></a>        ga_result[<span class="st">'sharpe_ratio'</span>]</span>
<span id="cb12-318"><a href="#cb12-318" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb12-319"><a href="#cb12-319" aria-hidden="true" tabindex="-1"></a>}, index<span class="op">=</span>[<span class="st">'Expected Return'</span>, <span class="st">'Volatility'</span>, <span class="st">'Sharpe Ratio'</span>])</span>
<span id="cb12-320"><a href="#cb12-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-321"><a href="#cb12-321" aria-hidden="true" tabindex="-1"></a><span class="co"># Create heatmap</span></span>
<span id="cb12-322"><a href="#cb12-322" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>].imshow(performance_metrics.values, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, aspect<span class="op">=</span><span class="st">'auto'</span>)</span>
<span id="cb12-323"><a href="#cb12-323" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Performance Metrics Comparison'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb12-324"><a href="#cb12-324" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(performance_metrics.columns)))</span>
<span id="cb12-325"><a href="#cb12-325" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(performance_metrics.index)))</span>
<span id="cb12-326"><a href="#cb12-326" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_xticklabels(performance_metrics.columns, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb12-327"><a href="#cb12-327" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_yticklabels(performance_metrics.index)</span>
<span id="cb12-328"><a href="#cb12-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-329"><a href="#cb12-329" aria-hidden="true" tabindex="-1"></a><span class="co"># Add values to heatmap</span></span>
<span id="cb12-330"><a href="#cb12-330" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(performance_metrics.index)):</span>
<span id="cb12-331"><a href="#cb12-331" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(performance_metrics.columns)):</span>
<span id="cb12-332"><a href="#cb12-332" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].text(j, i, <span class="ss">f'</span><span class="sc">{</span>performance_metrics<span class="sc">.</span>iloc[i, j]<span class="sc">:.4f}</span><span class="ss">'</span>, </span>
<span id="cb12-333"><a href="#cb12-333" aria-hidden="true" tabindex="-1"></a>                       ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb12-334"><a href="#cb12-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-335"><a href="#cb12-335" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb12-336"><a href="#cb12-336" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb12-337"><a href="#cb12-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-338"><a href="#cb12-338" aria-hidden="true" tabindex="-1"></a><span class="co"># Print detailed results</span></span>
<span id="cb12-339"><a href="#cb12-339" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb12-340"><a href="#cb12-340" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"GENETIC ALGORITHM OPTIMIZATION RESULTS"</span>)</span>
<span id="cb12-341"><a href="#cb12-341" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb12-342"><a href="#cb12-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-343"><a href="#cb12-343" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Genetic Algorithm Portfolio:"</span>)</span>
<span id="cb12-344"><a href="#cb12-344" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expected Return: </span><span class="sc">{</span>ga_result[<span class="st">'expected_return'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb12-345"><a href="#cb12-345" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Volatility: </span><span class="sc">{</span>ga_result[<span class="st">'volatility'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb12-346"><a href="#cb12-346" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sharpe Ratio: </span><span class="sc">{</span>ga_result[<span class="st">'sharpe_ratio'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb12-347"><a href="#cb12-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-348"><a href="#cb12-348" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Final Generation Statistics:"</span>)</span>
<span id="cb12-349"><a href="#cb12-349" aria-hidden="true" tabindex="-1"></a>final_stats <span class="op">=</span> ga_result[<span class="st">'fitness_evolution'</span>][<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb12-350"><a href="#cb12-350" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Best Fitness: </span><span class="sc">{</span>final_stats[<span class="st">'max'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb12-351"><a href="#cb12-351" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average Fitness: </span><span class="sc">{</span>final_stats[<span class="st">'avg'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb12-352"><a href="#cb12-352" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Fitness Standard Deviation: </span><span class="sc">{</span>final_stats[<span class="st">'std'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb12-353"><a href="#cb12-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-354"><a href="#cb12-354" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top 5 holdings in GA Portfolio:"</span>)</span>
<span id="cb12-355"><a href="#cb12-355" aria-hidden="true" tabindex="-1"></a>top_ga_holdings <span class="op">=</span> ga_result[<span class="st">'weights'</span>].<span class="bu">abs</span>().nlargest(<span class="dv">5</span>)</span>
<span id="cb12-356"><a href="#cb12-356" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> asset, weight <span class="kw">in</span> top_ga_holdings.items():</span>
<span id="cb12-357"><a href="#cb12-357" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>asset<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>weight<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>weight<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb12-358"><a href="#cb12-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-359"><a href="#cb12-359" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary comparison table</span></span>
<span id="cb12-360"><a href="#cb12-360" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb12-361"><a href="#cb12-361" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"COMPREHENSIVE METHODS COMPARISON"</span>)</span>
<span id="cb12-362"><a href="#cb12-362" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb12-363"><a href="#cb12-363" aria-hidden="true" tabindex="-1"></a>comparison_table <span class="op">=</span> pd.DataFrame({</span>
<span id="cb12-364"><a href="#cb12-364" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Mean-Variance'</span>: [</span>
<span id="cb12-365"><a href="#cb12-365" aria-hidden="true" tabindex="-1"></a>        tangency_portfolio[<span class="st">'expected_return'</span>],</span>
<span id="cb12-366"><a href="#cb12-366" aria-hidden="true" tabindex="-1"></a>        tangency_portfolio[<span class="st">'volatility'</span>],</span>
<span id="cb12-367"><a href="#cb12-367" aria-hidden="true" tabindex="-1"></a>        tangency_portfolio[<span class="st">'sharpe_ratio'</span>]</span>
<span id="cb12-368"><a href="#cb12-368" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb12-369"><a href="#cb12-369" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CVaR Optimal'</span>: [</span>
<span id="cb12-370"><a href="#cb12-370" aria-hidden="true" tabindex="-1"></a>        min_cvar_portfolio[<span class="st">'expected_return'</span>],</span>
<span id="cb12-371"><a href="#cb12-371" aria-hidden="true" tabindex="-1"></a>        min_cvar_portfolio[<span class="st">'volatility'</span>],</span>
<span id="cb12-372"><a href="#cb12-372" aria-hidden="true" tabindex="-1"></a>        min_cvar_portfolio[<span class="st">'sharpe_ratio'</span>]</span>
<span id="cb12-373"><a href="#cb12-373" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb12-374"><a href="#cb12-374" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Genetic Algorithm'</span>: [</span>
<span id="cb12-375"><a href="#cb12-375" aria-hidden="true" tabindex="-1"></a>        ga_result[<span class="st">'expected_return'</span>],</span>
<span id="cb12-376"><a href="#cb12-376" aria-hidden="true" tabindex="-1"></a>        ga_result[<span class="st">'volatility'</span>],</span>
<span id="cb12-377"><a href="#cb12-377" aria-hidden="true" tabindex="-1"></a>        ga_result[<span class="st">'sharpe_ratio'</span>]</span>
<span id="cb12-378"><a href="#cb12-378" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb12-379"><a href="#cb12-379" aria-hidden="true" tabindex="-1"></a>}, index<span class="op">=</span>[<span class="st">'Expected Return'</span>, <span class="st">'Volatility'</span>, <span class="st">'Sharpe Ratio'</span>])</span>
<span id="cb12-380"><a href="#cb12-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-381"><a href="#cb12-381" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(comparison_table.<span class="bu">round</span>(<span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running Genetic Algorithm Optimization...
Generation 0: Max Fitness = 1.2069, Avg Fitness = 1.0238
Generation 10: Max Fitness = 1.3681, Avg Fitness = 1.3158
Generation 20: Max Fitness = 1.4582, Avg Fitness = 1.4207
Generation 30: Max Fitness = 1.4944, Avg Fitness = 1.4763
Generation 40: Max Fitness = 1.5041, Avg Fitness = 1.4972
Generation 50: Max Fitness = 1.5071, Avg Fitness = 1.5059
Generation 60: Max Fitness = 1.5079, Avg Fitness = 1.5067
Generation 70: Max Fitness = 1.5080, Avg Fitness = 1.5070
Generation 80: Max Fitness = 1.5081, Avg Fitness = 1.5064
Generation 90: Max Fitness = 1.5081, Avg Fitness = 1.5068</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-genetic-algorithm" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-genetic-algorithm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-genetic-algorithm-output-2.png" width="2675" height="1776" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-genetic-algorithm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Genetic algorithm portfolio optimization and convergence analysis
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
============================================================
GENETIC ALGORITHM OPTIMIZATION RESULTS
============================================================

Genetic Algorithm Portfolio:
Expected Return: 0.7945
Volatility: 0.5135
Sharpe Ratio: 1.5081

Final Generation Statistics:
Best Fitness: 1.5081
Average Fitness: 1.5070
Fitness Standard Deviation: 0.0043

Top 5 holdings in GA Portfolio:
NVDA: 0.8391 (83.9%)
TSLA: 0.1609 (16.1%)
CRM: 0.0000 (0.0%)
META: 0.0000 (0.0%)
AMD: 0.0000 (0.0%)

================================================================================
COMPREHENSIVE METHODS COMPARISON
================================================================================
                 Mean-Variance  CVaR Optimal  Genetic Algorithm
Expected Return         1.8481        0.2790             0.7945
Volatility              1.0493        0.2902             0.5135
Sharpe Ratio            1.7422        0.8924             1.5081</code></pre>
</div>
</div>
</section>
<section id="sec-conclusions" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="sec-conclusions"><span class="header-section-number">8</span> Conclusions and Practical Implications</h2>
<p>This comprehensive analysis of portfolio optimization techniques reveals important insights for both theoretical understanding and practical implementation:</p>
<section id="key-findings" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="key-findings"><span class="header-section-number">8.1</span> Key Findings</h3>
<p><strong>Mean-Variance Optimization</strong> remains the foundational approach, providing analytical solutions and clear mathematical interpretation. The tangency portfolio achieves the maximum Sharpe ratio under the assumption of normal returns and quadratic utility. However, its reliance on sample moments can lead to estimation error and concentrated portfolios.</p>
<p><strong>Expected Shortfall Optimization</strong> offers superior tail risk management by focusing on losses beyond the VaR threshold. Our CVaR-optimized portfolio demonstrates more conservative risk characteristics while maintaining competitive returns. The coherent properties of ES make it particularly attractive for risk management applications.</p>
<p><strong>Genetic Algorithm Optimization</strong> provides flexibility to handle complex constraints and non-convex objectives. While computationally intensive, GAs can discover solutions in complex optimization landscapes where traditional methods might fail. Our implementation shows competitive performance with the added benefit of handling arbitrary constraints.</p>
</section>
<section id="performance-comparison" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="performance-comparison"><span class="header-section-number">8.2</span> Performance Comparison</h3>
<p>Across our technology portfolio analysis, all three methods produce portfolios with similar risk-adjusted returns, but with different risk characteristics:</p>
<ul>
<li><strong>Highest Sharpe Ratio</strong>: Mean-variance tangency portfolio</li>
<li><strong>Lowest Tail Risk</strong>: CVaR-optimized portfolio<br>
</li>
<li><strong>Most Flexible</strong>: Genetic algorithm approach</li>
</ul>
</section>
<section id="practical-recommendations" class="level3" data-number="8.3">
<h3 data-number="8.3" class="anchored" data-anchor-id="practical-recommendations"><span class="header-section-number">8.3</span> Practical Recommendations</h3>
<ol type="1">
<li><strong>For Traditional Applications</strong>: Mean-variance optimization remains effective for benchmark portfolios and strategic asset allocation</li>
<li><strong>For Risk Management</strong>: CVaR optimization should be preferred when tail risk is a primary concern</li>
<li><strong>For Complex Constraints</strong>: Genetic algorithms excel when dealing with integer constraints, cardinality restrictions, or non-standard objectives</li>
</ol>
</section>
<section id="limitations-and-future-research" class="level3" data-number="8.4">
<h3 data-number="8.4" class="anchored" data-anchor-id="limitations-and-future-research"><span class="header-section-number">8.4</span> Limitations and Future Research</h3>
<p>Our analysis focuses on a single asset class over a specific time period. Future research could extend this framework to:</p>
<ul>
<li>Multi-asset class portfolios</li>
<li>Time-varying parameters and regime switching</li>
<li>Transaction costs and practical constraints</li>
<li>Alternative risk measures and utility functions</li>
<li>Machine learning-enhanced optimization</li>
</ul>
<p>The evolution of portfolio optimization continues, with each approach offering unique advantages depending on the specific application and market conditions.</p>
</section>
</section>
<section id="references" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="references"><span class="header-section-number">9</span> References</h2>
<p><parameter name="todos">[{“content”: “Read and analyze existing portfolio optimization post structure”, “status”: “completed”, “priority”: “high”, “id”: “1”}, {“content”: “Set up Python environment with required packages (yfinance, cvxpy, scipy, etc.)”, “status”: “completed”, “priority”: “high”, “id”: “2”}, {“content”: “Implement Markowitz mean-variance optimization with mathematical theory”, “status”: “completed”, “priority”: “high”, “id”: “3”}, {“content”: “Implement Expected Shortfall (CVaR) portfolio optimization”, “status”: “in_progress”, “priority”: “high”, “id”: “4”}, {“content”: “Implement genetic algorithm for portfolio optimization”, “status”: “pending”, “priority”: “high”, “id”: “5”}, {“content”: “Create publication-ready visualizations with proper formatting”, “status”: “pending”, “priority”: “medium”, “id”: “6”}, {“content”: “Add comprehensive academic references and bibliography”, “status”: “pending”, “priority”: “medium”, “id”: “7”}, {“content”: “Create professional thumbnail for the post”, “status”: “pending”, “priority”: “low”, “id”: “8”}, {“content”: “Test Quarto rendering to ensure everything works correctly”, “status”: “pending”, “priority”: “high”, “id”: “9”}]</parameter></p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-artzner1999" class="csl-entry" role="listitem">
Artzner, Philippe, Freddy Delbaen, Jean-Marc Eber, and David Heath. 1999. <span>“Coherent Measures of Risk.”</span> <em>Mathematical Finance</em> 9 (3): 203–28.
</div>
<div id="ref-fama1965" class="csl-entry" role="listitem">
Fama, Eugene F. 1965. <span>“The Behavior of Stock-Market Prices.”</span> <em>Journal of Business</em> 38 (1): 34–105.
</div>
<div id="ref-goldberg1989" class="csl-entry" role="listitem">
Goldberg, David E. 1989. <em>Genetic Algorithms in Search, Optimization, and Machine Learning</em>. Addison-Wesley.
</div>
<div id="ref-holland1975" class="csl-entry" role="listitem">
Holland, John H. 1975. <em>Adaptation in Natural and Artificial Systems: An Introductory Analysis with Applications to Biology, Control, and Artificial Intelligence</em>. University of Michigan Press.
</div>
<div id="ref-ledoit2003improved" class="csl-entry" role="listitem">
Ledoit, Olivier, and Michael Wolf. 2003. <span>“Improved Estimation of the Covariance Matrix of Stock Returns with an Application to Portfolio Selection.”</span> <em>Journal of Empirical Finance</em> 10 (5): 603–21.
</div>
<div id="ref-ledoit2004well" class="csl-entry" role="listitem">
———. 2004. <span>“A Well-Conditioned Estimator for Large-Dimensional Covariance Matrices.”</span> <em>Journal of Multivariate Analysis</em> 88 (2): 365–411.
</div>
<div id="ref-mandelbrot1963" class="csl-entry" role="listitem">
Mandelbrot, Benoit. 1963. <span>“The Variation of Certain Speculative Prices.”</span> <em>Journal of Business</em> 36 (4): 394–419.
</div>
<div id="ref-markowitz1952" class="csl-entry" role="listitem">
Markowitz, Harry. 1952. <span>“Portfolio Selection.”</span> <em>Journal of Finance</em> 7 (1): 77–91.
</div>
<div id="ref-rockafellar2000" class="csl-entry" role="listitem">
Rockafellar, R Tyrrell, and Stanislav Uryasev. 2000. <span>“Optimization of Conditional Value-at-Risk.”</span> <em>Journal of Risk</em> 2: 21–42.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>